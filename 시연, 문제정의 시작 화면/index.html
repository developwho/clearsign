<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ClearSign — 임대차 계약서 위험 분석 AI</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      keyframes: {
        scan: {
          '0%': { top: '0%', opacity: '0' },
          '10%': { opacity: '1' },
          '90%': { opacity: '1' },
          '100%': { top: '100%', opacity: '0' },
        },
        'pulse-ring': {
          '0%': { transform: 'scale(0.8)', opacity: '0.5' },
          '100%': { transform: 'scale(2)', opacity: '0' },
        },
        shimmer: {
          '0%': { transform: 'translateX(-100%) skewX(-12deg)' },
          '100%': { transform: 'translateX(200%) skewX(-12deg)' },
        },
        'bounce-dot': {
          '0%, 80%, 100%': { transform: 'translateY(0)' },
          '40%': { transform: 'translateY(-6px)' },
        },
      },
      animation: {
        scan: 'scan 2s cubic-bezier(0.4,0,0.2,1) infinite',
        'pulse-ring': 'pulse-ring 2s cubic-bezier(0.215,0.61,0.355,1) infinite',
        shimmer: 'shimmer 1.5s infinite',
        'bounce-dot': 'bounce-dot 1.4s infinite ease-in-out both',
      },
    }
  }
}
</script>
<style>
  :root {
    --primary-indigo: #4F46E5;
    --primary-indigo-hover: #4338CA;
    --bg-dark: #0a0a0f;
    --card-dark: #13131f;
    --border-dark: #2a2a3a;
    --text-muted: #9ca3af;
    --risk-high: #EF4444;
    --safe-green: #10B981;
  }
  body {
    font-family: 'Noto Sans KR', sans-serif;
    transition: background-color 0.4s ease, color 0.4s ease;
  }
  .serif-text { font-family: 'Noto Serif KR', serif; }
  .scrambled-text { filter: blur(0.5px); opacity: 0.7; }
  .glass-panel {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-dark);
  }
  .screen { display: none; }
  .screen.active { display: flex; }
  /* scan-line for loading */
  .scan-line {
    animation: scan 2s cubic-bezier(0.4,0,0.2,1) infinite;
    background: linear-gradient(to bottom, transparent, var(--primary-indigo), transparent);
    box-shadow: 0 0 15px var(--primary-indigo);
  }
  /* risk highlight */
  .clause-risk-highlight {
    background: rgba(239,68,68,0.08);
    border-left: 3px solid #EF4444;
    cursor: pointer;
    transition: background 0.2s;
  }
  .clause-risk-highlight:hover { background: rgba(239,68,68,0.14); }
  .clause-risk-highlight.active { background: rgba(239,68,68,0.18); }
  .clause-safe { border-left: 3px solid transparent; padding-left: 16px; }
  /* scrollbar */
  .custom-scroll::-webkit-scrollbar { width: 6px; }
  .custom-scroll::-webkit-scrollbar-track { background: transparent; }
  .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
  .dark-scroll::-webkit-scrollbar-thumb { background: #374151; }
  /* tab underline */
  .tab-btn { position: relative; padding-bottom: 8px; }
  .tab-btn.active-tab::after {
    content: '';
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 2px; background: var(--primary-indigo); border-radius: 1px;
  }
  /* progress shimmer */
  .progress-shimmer {
    position: relative; overflow: hidden;
  }
  .progress-shimmer::after {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    animation: shimmer 1.5s infinite;
  }

  /* Grammarly-style annotation: danger */
  .annotation-danger {
    background: linear-gradient(to bottom, transparent 60%, rgba(239,68,68,0.12) 60%);
    text-decoration: underline wavy #EF4444;
    text-decoration-skip-ink: none;
    text-underline-offset: 4px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }
  .annotation-danger:hover {
    background: linear-gradient(to bottom, transparent 50%, rgba(239,68,68,0.18) 50%);
  }
  /* Grammarly-style annotation: caution */
  .annotation-caution {
    background: linear-gradient(to bottom, transparent 60%, rgba(245,158,11,0.10) 60%);
    text-decoration: underline wavy #F59E0B;
    text-decoration-skip-ink: none;
    text-underline-offset: 4px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }
  .annotation-caution:hover {
    background: linear-gradient(to bottom, transparent 50%, rgba(245,158,11,0.16) 50%);
  }
  /* Margin marker badge */
  .annotation-marker {
    position: absolute; right: -36px; top: 8px;
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: transform 0.15s;
  }
  .annotation-marker:hover { transform: scale(1.15); }
  /* Hover tooltip */
  .annotation-tooltip {
    position: absolute; bottom: calc(100% + 8px); left: 50%;
    transform: translateX(-50%);
    background: #1f2937; color: #fff;
    padding: 8px 14px; border-radius: 10px;
    font-size: 13px; line-height: 1.5;
    max-width: 320px; white-space: normal;
    opacity: 0; transition: opacity 0.2s;
    pointer-events: none; z-index: 30;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  }
  .annotation-tooltip::after {
    content: ''; position: absolute; top: 100%; left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent; border-top-color: #1f2937;
  }
  .annotation-danger:hover .annotation-tooltip,
  .annotation-caution:hover .annotation-tooltip { opacity: 1; }
  /* Pulse highlight for scroll-to */
  @keyframes clause-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(99,102,241,0.4); }
    50% { box-shadow: 0 0 0 6px rgba(99,102,241,0); }
  }
  .clause-pulse { animation: clause-pulse 0.8s ease-out 2; }
  /* Demo banner */
  .demo-banner {
    background: linear-gradient(135deg, #EEF2FF, #E0E7FF);
    border: 1px dashed #818CF8;
  }
  /* File preview collapse */
  .file-preview-container { transition: max-height 0.3s ease; overflow: hidden; }
</style>
</head>

<body class="bg-[#0a0a0f] text-white min-h-screen">

<!-- ============================================================ -->
<!-- SCREEN 1: INTRO (dark, no sidebar)                            -->
<!-- ============================================================ -->
<div id="introScreen" class="screen active h-screen w-full flex-col items-center justify-center relative overflow-hidden">
  <!-- BG blurs -->
  <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
    <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-900/20 rounded-full blur-[120px]"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-600/10 rounded-full blur-[120px]"></div>
  </div>
  <!-- Nav -->
  <nav class="absolute top-0 left-0 w-full p-8 flex justify-between items-center z-20">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-[var(--primary-indigo)] rounded-lg flex items-center justify-center text-white">
        <span class="material-symbols-outlined text-xl">assignment_turned_in</span>
      </div>
      <span class="font-bold text-xl tracking-tight">ClearSign</span>
    </div>
    <div class="hidden md:flex gap-6 text-sm text-gray-400 items-center">
      <a class="hover:text-white transition-colors cursor-pointer" onclick="showScreen('upload')">서비스 소개</a>
      <a class="hover:text-white transition-colors cursor-pointer">요금제</a>
      <!-- Google Login / User Profile -->
      <div id="loginBtnIntro" class="relative">
        <button onclick="onLoginClick()" class="hover:text-white transition-colors flex items-center gap-1.5">
          <span class="material-symbols-outlined text-lg">person</span>
          로그인
        </button>
        <div id="googleLoginDropdown" class="hidden absolute right-0 top-10 bg-[#1a1a2e] border border-indigo-500/30 rounded-xl p-4 shadow-2xl min-w-[240px] z-50">
          <p class="text-xs text-gray-400 mb-3">Google 계정으로 로그인</p>
          <div id="googleBtnContainer"></div>
          <p id="loginUnavailableMsg" class="hidden text-xs text-red-400 mt-2">Google 로그인을 사용할 수 없습니다.</p>
        </div>
      </div>
      <div id="userProfileIntro" class="hidden flex items-center gap-2 cursor-pointer" onclick="toggleUserMenu()">
        <img id="userAvatarIntro" class="w-8 h-8 rounded-full border border-indigo-500/30" src="" alt=""/>
        <span id="userNameIntro" class="text-white text-sm font-medium"></span>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <main class="relative z-10 w-full max-w-5xl px-6 flex flex-col md:flex-row items-center gap-12 lg:gap-20 m-auto">
    <!-- Left: Text -->
    <div class="flex-1 space-y-8 text-center md:text-left">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-900/30 border border-indigo-500/30 text-indigo-300 text-xs font-medium mb-2">
        <span class="w-2 h-2 rounded-full bg-indigo-400 animate-pulse"></span>
        AI 수어 통역 엔진 v2.0
      </div>
      <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight tracking-tight">
        계약서, <br/>
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-indigo-200">이제 보이는 언어로</span> <br/>
        확인하세요.
      </h1>
      <p class="text-gray-400 text-lg md:text-xl font-light leading-relaxed max-w-lg mx-auto md:mx-0">
        복잡한 법률 용어와 숨겨진 독소 조항, <br/>
        ClearSign이 당신의 모국어인 수어와 쉬운 그림으로 <br/>
        직관적이고 명확하게 보여드립니다.
      </p>
      <div class="pt-4 flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
        <button onclick="showScreen('upload')" class="group relative px-8 py-4 bg-[var(--primary-indigo)] hover:bg-[var(--primary-indigo-hover)] text-white rounded-full shadow-[0_0_20px_rgba(79,70,229,0.3)] hover:shadow-[0_0_30px_rgba(79,70,229,0.5)] transition-all flex items-center justify-center gap-3 font-medium text-lg overflow-hidden">
          <span class="relative z-10">내 계약서 분석하기</span>
          <span class="material-symbols-outlined relative z-10 group-hover:translate-x-1 transition-transform">arrow_forward</span>
          <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out skew-y-12"></div>
        </button>
        <button onclick="loadDemo()" class="px-8 py-4 bg-white/5 hover:bg-white/10 border border-white/10 text-white rounded-full transition-all flex items-center justify-center gap-2 backdrop-blur-sm">
          <span class="material-symbols-outlined">play_circle</span>
          <span>작동 원리 보기</span>
        </button>
      </div>
      <div class="pt-8 flex items-center gap-4 justify-center md:justify-start opacity-60">
        <div class="flex -space-x-3">
          <div class="w-10 h-10 rounded-full border-2 border-[var(--bg-dark)] bg-gray-700"></div>
          <div class="w-10 h-10 rounded-full border-2 border-[var(--bg-dark)] bg-gray-600"></div>
          <div class="w-10 h-10 rounded-full border-2 border-[var(--bg-dark)] bg-gray-500"></div>
        </div>
        <p class="text-sm text-gray-400">
          <span class="font-bold text-white">1,204명</span>이 오늘 안전하게 계약했습니다
        </p>
      </div>
    </div>

    <!-- Right: Contract Card -->
    <div class="flex-1 w-full max-w-md md:max-w-full">
      <div class="relative group">
        <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
        <div class="relative bg-[var(--card-dark)] border border-white/10 rounded-2xl p-8 shadow-2xl overflow-hidden">
          <!-- Window dots -->
          <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-4">
            <div class="flex gap-2">
              <div class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></div>
              <div class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
              <div class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></div>
            </div>
            <div class="text-xs font-mono text-gray-500 flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
              AI ANALYZING...
            </div>
          </div>
          <!-- Before -->
          <div class="relative space-y-4 mb-8">
            <div class="absolute -left-4 top-0 bottom-0 w-1 bg-gradient-to-b from-transparent via-red-500/50 to-transparent"></div>
            <h3 class="text-sm text-gray-500 font-mono mb-2 uppercase tracking-wider">Before Analysis</h3>
            <div class="serif-text text-gray-400 space-y-3 text-sm leading-relaxed scrambled-text select-none" lang="ja">
              <p>第4条（敷金返還） 賃貸人は 賃貸借期間が 満了되어 賃借人으로부터 敷金을 受領하는 即時... 本 契約의 特約事項에 依據하여 第█項의 規定은 排除되며...</p>
              <p>賃借人の 過失로 인한 破損 및 毀損에 대해서는 原状復旧의 義務를 가지며, 이는 通常的인 磨耗를 包含하지 아니한다. 但, 天災地変에 의한...</p>
            </div>
            <p class="text-[11px] text-indigo-400/60 italic mt-1">이것이 농인이 보는 계약서입니다. 글자는 보입니다. 의미는 도달하지 않습니다.</p>
            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-indigo-500/10 to-transparent h-[100px] w-full animate-scan pointer-events-none border-b border-indigo-500/30"></div>
          </div>
          <!-- AI preview -->
          <div class="bg-indigo-500/5 rounded-xl border border-indigo-500/20 p-5 relative overflow-hidden transition-all duration-500 hover:bg-indigo-500/10">
            <div class="absolute top-0 right-0 p-3 opacity-20">
              <span class="material-symbols-outlined text-4xl text-indigo-400">smart_toy</span>
            </div>
            <h3 class="text-sm text-indigo-400 font-bold mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-lg">check_circle</span>
              핵심 의미 추출
            </h3>
            <div class="space-y-3">
              <div class="flex items-start gap-3">
                <div class="mt-1 min-w-[24px] h-6 rounded bg-indigo-500/20 flex items-center justify-center text-indigo-300 text-xs font-bold">1</div>
                <p class="text-sm text-gray-200"><span class="text-red-400 font-medium">위험:</span> 다음 세입자가 들어와야 돈을 돌려준다는 조건이 있습니다.</p>
              </div>
              <div class="flex items-start gap-3">
                <div class="mt-1 min-w-[24px] h-6 rounded bg-indigo-500/20 flex items-center justify-center text-indigo-300 text-xs font-bold">2</div>
                <p class="text-sm text-gray-200">이사 날짜에 보증금을 바로 받지 못할 확률이 <span class="text-indigo-400 font-medium">92%</span>입니다.</p>
              </div>
            </div>
            <div class="mt-4 pt-3 border-t border-indigo-500/10 flex justify-between items-center">
              <span class="text-xs text-gray-500">생성된 시나리오 3건</span>
              <span class="text-xs text-indigo-300 flex items-center gap-1 cursor-pointer hover:underline">
                자세히 보기 <span class="material-symbols-outlined text-xs">arrow_forward</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- SCREEN 2: UPLOAD (dark + sidebar)                             -->
<!-- ============================================================ -->
<div id="uploadScreen" class="screen h-screen overflow-hidden">
  <!-- Sidebar (dark) -->
  <aside id="sidebarUpload" class="w-20 border-r border-[#2a2a3a] flex flex-col items-center py-6 flex-shrink-0 z-20 bg-[#0a0a0f]">
    <div class="mb-8 cursor-pointer" onclick="showScreen('intro')">
      <span class="material-symbols-outlined text-3xl text-[var(--primary-indigo)]">assignment_turned_in</span>
    </div>
    <nav class="flex-1 space-y-6 w-full flex flex-col items-center">
      <button class="p-3 rounded-xl bg-indigo-500/10 text-[var(--primary-indigo)] border border-indigo-500/20 transition-colors relative group">
        <span class="material-symbols-outlined">upload_file</span>
        <span class="absolute left-14 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-gray-700 z-50">계약서 업로드</span>
      </button>
      <button class="p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-gray-200 transition-colors relative group">
        <span class="material-symbols-outlined">folder_open</span>
        <span class="absolute left-14 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-gray-700 z-50">보관함</span>
      </button>
      <button class="p-3 rounded-xl text-gray-400 hover:bg-white/5 hover:text-gray-200 transition-colors relative group">
        <span class="material-symbols-outlined">settings</span>
        <span class="absolute left-14 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-gray-700 z-50">설정</span>
      </button>
    </nav>
    <div class="mt-auto sidebar-avatar">
      <div class="w-10 h-10 rounded-full bg-gray-800 overflow-hidden border border-gray-700 flex items-center justify-center text-gray-500">
        <span class="material-symbols-outlined sidebar-avatar-icon">person</span>
        <img class="sidebar-avatar-img hidden w-full h-full object-cover" src="" alt=""/>
      </div>
    </div>
  </aside>

  <!-- Main upload area -->
  <main class="flex-1 flex flex-col items-center justify-center p-8 relative overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
      <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-indigo-600/10 rounded-full blur-3xl"></div>
      <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-indigo-900/10 rounded-full blur-3xl"></div>
    </div>
    <div class="max-w-3xl w-full z-10 space-y-10 text-center">
      <div class="space-y-4">
        <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
          계약서 분석 시작하기
        </h1>
        <p class="text-lg text-gray-400 font-light max-w-2xl mx-auto">
          AI가 복잡한 법률 용어를 이해하기 쉬운 수어와 시나리오로 변환해드립니다.
          <br class="hidden md:block"/>
          PDF 또는 이미지 파일을 업로드하세요.
        </p>
      </div>

      <!-- Upload drop zone -->
      <div class="group relative w-full" id="dropZone">
        <input class="hidden" id="fileInput" type="file" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileSelect(event)"/>
        <label class="block w-full cursor-pointer" for="fileInput">
          <div class="glass-panel rounded-3xl p-16 flex flex-col items-center justify-center transition-all duration-300 group-hover:border-indigo-500/50 group-hover:bg-white/[0.04]" id="dropArea">
            <div class="w-24 h-24 mb-8 rounded-full bg-[#1a1a24] flex items-center justify-center group-hover:scale-105 transition-transform duration-300 border border-[#2a2a3a]">
              <span class="material-symbols-outlined text-4xl text-indigo-400">cloud_upload</span>
            </div>
            <h3 class="text-xl font-medium text-white mb-2">계약서 파일을 이곳에 드래그하세요</h3>
            <p class="text-sm text-gray-500 mb-8">또는 클릭하여 파일 선택 (PDF, JPG, PNG)</p>
            <span class="px-8 py-3 rounded-xl border border-indigo-500/30 text-indigo-300 font-medium hover:bg-indigo-500/10 hover:border-indigo-500/60 transition-all duration-200 flex items-center gap-2">
              <span class="material-symbols-outlined text-sm">folder_open</span>
              파일 선택하기
            </span>
          </div>
        </label>
        <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-3xl opacity-0 group-hover:opacity-20 blur transition duration-500 pointer-events-none"></div>
      </div>

      <!-- Security note + sample link -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-6 text-sm text-gray-500">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-base">security</span>
          <span>모든 문서는 암호화되어 안전하게 처리됩니다</span>
        </div>
        <div class="hidden md:block w-1 h-1 bg-gray-700 rounded-full"></div>
        <a class="flex items-center gap-1 text-indigo-400 hover:text-indigo-300 transition-colors group cursor-pointer" onclick="loadDemo()">
          <span>샘플 계약서로 미리보기</span>
          <span class="material-symbols-outlined text-base group-hover:translate-x-0.5 transition-transform">arrow_forward</span>
        </a>
      </div>
    </div>

    <!-- Recent history -->
    <div class="mt-16 w-full max-w-3xl glass-panel rounded-2xl p-6 opacity-60 hover:opacity-100 transition-opacity">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-sm font-semibold text-gray-300 flex items-center gap-2">
          <span class="material-symbols-outlined text-base">history</span>
          최근 분석 기록
        </h4>
      </div>
      <div class="space-y-3">
        <div class="flex items-center justify-between p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer group border border-transparent hover:border-gray-800">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-red-500/10 flex items-center justify-center text-red-400 border border-red-500/20">
              <span class="material-symbols-outlined text-sm">picture_as_pdf</span>
            </div>
            <div>
              <p class="text-sm text-gray-200 font-medium group-hover:text-indigo-300 transition-colors">서울시 관악구 원룸 전세계약서.pdf</p>
              <p class="text-xs text-gray-500">2023. 10. 24. 오후 2:30</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-2 py-1 rounded text-[10px] font-medium bg-red-500/10 text-red-400 border border-red-500/20">위험 감지</span>
            <span class="material-symbols-outlined text-gray-600 group-hover:text-gray-400">chevron_right</span>
          </div>
        </div>
        <div class="flex items-center justify-between p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer group border border-transparent hover:border-gray-800">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20">
              <span class="material-symbols-outlined text-sm">image</span>
            </div>
            <div>
              <p class="text-sm text-gray-200 font-medium group-hover:text-indigo-300 transition-colors">오피스텔 임대차 계약서_촬영본.jpg</p>
              <p class="text-xs text-gray-500">2023. 10. 22. 오전 11:15</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-2 py-1 rounded text-[10px] font-medium bg-green-500/10 text-green-400 border border-green-500/20">안전</span>
            <span class="material-symbols-outlined text-gray-600 group-hover:text-gray-400">chevron_right</span>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- SCREEN 3: LOADING (light + sidebar)                           -->
<!-- ============================================================ -->
<div id="loadingScreen" class="screen h-screen overflow-hidden">
  <!-- Sidebar (light) -->
  <aside class="w-20 bg-white border-r border-gray-200 flex flex-col items-center py-6 flex-shrink-0 z-20">
    <div class="mb-8">
      <span class="material-symbols-outlined text-3xl text-[var(--primary-indigo)]">assignment_turned_in</span>
    </div>
    <nav class="flex-1 space-y-6 w-full flex flex-col items-center">
      <button class="p-3 rounded-xl bg-indigo-50 text-[var(--primary-indigo)] transition-colors">
        <span class="material-symbols-outlined">description</span>
      </button>
      <button class="p-3 rounded-xl text-gray-400 hover:bg-gray-50 hover:text-gray-600 transition-colors">
        <span class="material-symbols-outlined">folder_open</span>
      </button>
      <button class="p-3 rounded-xl text-gray-400 hover:bg-gray-50 hover:text-gray-600 transition-colors">
        <span class="material-symbols-outlined">settings</span>
      </button>
    </nav>
    <div class="mt-auto">
      <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border border-gray-300 flex items-center justify-center text-gray-400">
        <span class="material-symbols-outlined">person</span>
      </div>
    </div>
  </aside>

  <!-- Loading content -->
  <main class="flex-1 flex flex-col items-center justify-center relative bg-gray-50 overflow-hidden">
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
      <div class="absolute top-[20%] left-[10%] w-64 h-64 bg-indigo-200 rounded-full blur-[100px] opacity-30"></div>
      <div class="absolute bottom-[20%] right-[10%] w-80 h-80 bg-blue-100 rounded-full blur-[120px] opacity-40"></div>
    </div>
    <div class="relative z-10 flex flex-col items-center">
      <!-- Document preview -->
      <div class="relative w-72 bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden mb-12">
        <div class="h-4 bg-indigo-50 border-b border-indigo-100 flex items-center px-3 gap-1.5">
          <div class="w-1.5 h-1.5 rounded-full bg-indigo-200"></div>
          <div class="w-1.5 h-1.5 rounded-full bg-indigo-200"></div>
        </div>
        <div class="p-6 space-y-4">
          <div class="h-6 bg-gray-100 rounded w-3/4"></div>
          <div class="space-y-2">
            <div class="h-3 bg-gray-50 rounded w-full"></div>
            <div class="h-3 bg-gray-50 rounded w-5/6"></div>
            <div class="h-3 bg-gray-50 rounded w-full"></div>
            <div class="h-3 bg-gray-50 rounded w-4/6"></div>
          </div>
          <div class="h-20 bg-indigo-50/50 rounded-lg border border-indigo-50 p-3 space-y-2">
            <div class="h-2 bg-indigo-100 rounded w-1/3"></div>
            <div class="h-2 bg-indigo-100/50 rounded w-full"></div>
            <div class="h-2 bg-indigo-100/50 rounded w-5/6"></div>
          </div>
        </div>
        <!-- Scan line -->
        <div class="absolute left-0 right-0 h-1 scan-line z-20"></div>
        <div class="absolute inset-0 bg-gradient-to-b from-white/10 to-indigo-50/10 pointer-events-none"></div>
      </div>

      <!-- Pulse icon -->
      <div class="relative flex items-center justify-center mb-8">
        <div class="absolute w-16 h-16 rounded-full border-2 border-indigo-100 animate-pulse-ring"></div>
        <div class="absolute w-16 h-16 rounded-full border-2 border-indigo-50 animate-pulse-ring" style="animation-delay:0.5s"></div>
        <div class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-[var(--primary-indigo)] relative z-10 border border-indigo-50">
          <span class="material-symbols-outlined text-2xl animate-spin">smart_toy</span>
        </div>
      </div>

      <h2 class="text-xl font-bold text-gray-900 mb-3 tracking-tight">조항을 분석하고 있습니다...</h2>
      <p class="text-gray-500 text-sm font-medium flex items-center gap-2">
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce-dot"></span>
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce-dot" style="animation-delay:0.16s"></span>
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce-dot" style="animation-delay:0.32s"></span>
        <span id="loadingStatusText">AI가 위험 요소를 감지하는 중</span>
      </p>
      <!-- Progress bar -->
      <div class="w-64 h-1.5 bg-gray-200 rounded-full mt-8 overflow-hidden">
        <div id="progressBar" class="h-full bg-[var(--primary-indigo)] rounded-full shadow-[0_0_10px_rgba(79,70,229,0.4)] progress-shimmer transition-all duration-500" style="width:0%"></div>
      </div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- SCREEN 4: RESULT (light + sidebar)                            -->
<!-- ============================================================ -->
<div id="resultScreen" class="screen h-screen overflow-hidden">
  <!-- Sidebar (light) -->
  <aside class="w-20 bg-white border-r border-gray-200 flex flex-col items-center py-6 flex-shrink-0 z-20">
    <div class="mb-8 cursor-pointer" onclick="showScreen('intro')">
      <span class="material-symbols-outlined text-3xl text-[var(--primary-indigo)]">assignment_turned_in</span>
    </div>
    <nav class="flex-1 space-y-6 w-full flex flex-col items-center">
      <button class="p-3 rounded-xl bg-indigo-50 text-[var(--primary-indigo)] transition-colors">
        <span class="material-symbols-outlined">description</span>
      </button>
      <button class="p-3 rounded-xl text-gray-400 hover:bg-gray-50 hover:text-gray-600 transition-colors">
        <span class="material-symbols-outlined">folder_open</span>
      </button>
      <button onclick="showScreen('upload')" class="p-3 rounded-xl text-gray-400 hover:bg-gray-50 hover:text-gray-600 transition-colors">
        <span class="material-symbols-outlined">upload_file</span>
      </button>
      <button class="p-3 rounded-xl text-gray-400 hover:bg-gray-50 hover:text-gray-600 transition-colors">
        <span class="material-symbols-outlined">settings</span>
      </button>
    </nav>
    <div class="mt-auto sidebar-avatar">
      <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border border-gray-300 flex items-center justify-center text-gray-400">
        <span class="material-symbols-outlined sidebar-avatar-icon">person</span>
        <img class="sidebar-avatar-img hidden w-full h-full object-cover" src="" alt=""/>
      </div>
    </div>
  </aside>

  <!-- Result content: 2-column -->
  <main class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
    <!-- Top bar -->
    <div class="px-8 py-4 bg-white border-b border-gray-200 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-gray-400">description</span>
        <span id="resultDemoTag" class="px-2 py-0.5 rounded text-[10px] font-bold bg-indigo-100 text-indigo-600 hidden">데모</span>
        <span id="resultFileName" class="text-sm font-medium text-gray-700">2024년 2월 주택임대차계약서.pdf</span>
        <span id="resultRiskBadge" class="px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600">위험</span>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="showScreen('upload')" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-1.5">
          <span class="material-symbols-outlined text-base">upload_file</span>
          새 계약서 분석
        </button>
      </div>
    </div>

    <!-- 2-column body -->
    <div class="flex-1 flex overflow-hidden">
      <!-- LEFT: Contract document viewer -->
      <div class="flex-1 overflow-y-auto custom-scroll p-8" id="contractViewer">
        <div class="max-w-2xl mx-auto pr-10">
          <!-- Demo mode banner (hidden by default) -->
          <div id="demoBanner" class="demo-banner rounded-xl p-4 mb-6 hidden">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-indigo-500 text-xl">science</span>
              <div>
                <p class="text-sm font-bold text-indigo-700">데모 모드</p>
                <p class="text-xs text-indigo-500">샘플 위험 계약서로 분석 결과를 미리 확인합니다</p>
              </div>
            </div>
          </div>

          <!-- File preview (collapsible, only for real uploads) -->
          <div id="filePreviewSection" class="mb-6 hidden">
            <button onclick="toggleFilePreview()" class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-700 mb-2 transition-colors">
              <span class="material-symbols-outlined text-base" id="filePreviewToggleIcon">expand_more</span>
              <span>원본 파일 미리보기</span>
            </button>
            <div id="filePreviewContainer" class="file-preview-container max-h-[200px] rounded-xl border border-gray-200 overflow-hidden bg-white">
              <div id="filePreviewContent" class="w-full h-[200px] flex items-center justify-center"></div>
            </div>
          </div>

          <h2 class="text-xl font-bold text-gray-900 mb-1">부동산임대차계약서</h2>
          <p class="text-sm text-gray-400 mb-6">국토교통부 표준 계약서 기준 분석 결과</p>
          <!-- Summary cards -->
          <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-xl border border-gray-200 p-4 text-center">
              <p class="text-xs text-gray-400 mb-1">위험 조항</p>
              <p id="summaryRiskCount" class="text-2xl font-bold text-red-500">-</p>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 text-center">
              <p class="text-xs text-gray-400 mb-1">전체 조항</p>
              <p id="summaryTotalCount" class="text-2xl font-bold text-gray-900">-</p>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 text-center">
              <p class="text-xs text-gray-400 mb-1">최대 위험 금액</p>
              <p id="summaryMaxRisk" class="text-2xl font-bold text-red-500">-</p>
            </div>
          </div>
          <!-- Clauses rendered here (Grammarly annotation view) -->
          <div id="clauseList" class="space-y-1"></div>
        </div>
      </div>

      <!-- RIGHT: Analysis panel -->
      <div id="sidePanel" class="w-[420px] bg-white border-l border-gray-200 flex flex-col overflow-hidden flex-shrink-0">
        <!-- Default: checklist view -->
        <div id="panelDefault" class="flex-1 overflow-y-auto custom-scroll p-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-indigo-500">checklist</span>
            핵심 확인 리스트
          </h3>
          <div id="checklistItems" class="space-y-3"></div>

          <!-- Charts -->
          <div class="mt-8 space-y-6">
            <div>
              <h4 class="text-sm font-semibold text-gray-700 mb-3">조항별 위험도</h4>
              <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                <canvas id="deviationChart" height="200"></canvas>
              </div>
            </div>
            <div>
              <h4 class="text-sm font-semibold text-gray-700 mb-3">위험 등급 분포</h4>
              <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                <canvas id="riskChart" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- Overall action -->
          <div id="overallActionBox" class="mt-6 bg-red-50 border border-red-200 rounded-xl p-4 hidden">
            <h4 class="text-sm font-bold text-red-700 mb-2 flex items-center gap-1.5">
              <span class="material-symbols-outlined text-base">warning</span>
              전체 경고
            </h4>
            <p id="overallActionText" class="text-sm text-red-600 whitespace-pre-line"></p>
          </div>
        </div>

        <!-- Detail: shown when a clause is clicked -->
        <div id="panelDetail" class="flex-1 overflow-y-auto custom-scroll p-6 hidden">
          <button onclick="closePanelDetail()" class="mb-4 text-sm text-gray-400 hover:text-gray-600 flex items-center gap-1 transition-colors">
            <span class="material-symbols-outlined text-base">arrow_back</span>
            리스트로 돌아가기
          </button>
          <div class="flex items-center gap-2 mb-4">
            <span id="detailNumber" class="text-lg font-bold text-gray-900"></span>
            <span id="detailTitle" class="text-lg font-bold text-gray-900"></span>
            <span id="detailBadge" class="px-2 py-0.5 rounded text-xs font-bold"></span>
          </div>

          <!-- Deviation bar -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-1.5">
              <span class="text-xs text-gray-500">표준 이탈도</span>
              <span id="detailScore" class="text-xs font-bold"></span>
            </div>
            <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
              <div id="detailScoreBar" class="h-full rounded-full transition-all duration-500"></div>
            </div>
            <p id="detailDirection" class="text-xs text-gray-400 mt-1.5"></p>
          </div>

          <!-- Easy Korean tabs -->
          <div class="mb-6">
            <div class="flex gap-4 border-b border-gray-100 mb-4">
              <button class="tab-btn active-tab text-sm font-medium text-indigo-600" onclick="switchTab(1)">쉬운 설명</button>
              <button class="tab-btn text-sm font-medium text-gray-400 hover:text-gray-600" onclick="switchTab(2)">비유 설명</button>
              <button class="tab-btn text-sm font-medium text-gray-400 hover:text-gray-600" onclick="switchTab(3)">시나리오</button>
            </div>
            <div id="easyKoreanContent" class="text-sm text-gray-700 leading-relaxed bg-indigo-50/50 rounded-xl p-4 border border-indigo-100"></div>
          </div>

          <!-- Original vs Standard -->
          <div class="mb-6 space-y-3">
            <div>
              <h4 class="text-xs font-semibold text-red-500 mb-1.5 flex items-center gap-1">
                <span class="material-symbols-outlined text-xs">error</span>
                이 계약서 원문
              </h4>
              <p id="detailOriginal" class="text-sm text-gray-600 bg-red-50 rounded-lg p-3 border border-red-100 leading-relaxed"></p>
            </div>
            <div>
              <h4 class="text-xs font-semibold text-green-600 mb-1.5 flex items-center gap-1">
                <span class="material-symbols-outlined text-xs">verified</span>
                표준 계약서 원문
              </h4>
              <p id="detailStandard" class="text-sm text-gray-600 bg-green-50 rounded-lg p-3 border border-green-100 leading-relaxed"></p>
            </div>
          </div>

          <!-- Action script -->
          <div id="detailActionBox" class="bg-amber-50 border border-amber-200 rounded-xl p-4">
            <h4 class="text-sm font-bold text-amber-700 mb-2 flex items-center gap-1.5">
              <span class="material-symbols-outlined text-base">record_voice_over</span>
              행동 스크립트
            </h4>
            <p id="detailActionMessage" class="text-sm text-amber-800 whitespace-pre-line leading-relaxed"></p>
            <button onclick="copyAction()" class="mt-3 px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5">
              <span class="material-symbols-outlined text-sm">content_copy</span>
              수정 요청 문구 복사
            </button>
          </div>
        </div>

        <!-- Bottom CTA -->
        <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
          <button class="w-full py-3 bg-[var(--primary-indigo)] hover:bg-[var(--primary-indigo-hover)] text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-lg">summarize</span>
            전체 리포트 보러가기
          </button>
        </div>
      </div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- JAVASCRIPT                                                     -->
<!-- ============================================================ -->
<script>
// ---- State ----
let analysisData = null;
let currentClauseIdx = -1;
let currentTabLevel = 1;
let deviationChartInstance = null;
let riskChartInstance = null;
let uploadedFileUrl = null;
let uploadedFileType = null;
let isDemoMode = false;
let currentUser = null;
let filePreviewOpen = true;
let loadingStartTime = 0;

// ---- Google OAuth ----
let googleLoginReady = false;

function onLoginClick() {
  const dropdown = document.getElementById('googleLoginDropdown');
  const msg = document.getElementById('loginUnavailableMsg');
  dropdown.classList.toggle('hidden');
  if (!googleLoginReady && msg) msg.classList.remove('hidden');
}

async function initGoogleLogin() {
  try {
    const res = await fetch('/api/config');
    const cfg = await res.json();
    if (!cfg.googleClientId) return;
    google.accounts.id.initialize({
      client_id: cfg.googleClientId,
      callback: handleGoogleLogin,
    });
    google.accounts.id.renderButton(
      document.getElementById('googleBtnContainer'),
      { theme: 'filled_black', size: 'large', shape: 'pill', text: 'signin_with', width: 208 }
    );
    googleLoginReady = true;
  } catch (e) { console.log('Google login unavailable'); }
}

function handleGoogleLogin(response) {
  try {
    const token = response.credential;
    const payload = JSON.parse(atob(token.split('.')[1]));
    currentUser = { name: payload.name, picture: payload.picture, email: payload.email };
    localStorage.setItem('gsi_token', token);
    const dropdown = document.getElementById('googleLoginDropdown');
    if (dropdown) dropdown.classList.add('hidden');
    updateUserUI();
  } catch (e) {
    console.error('Google login error:', e);
  }
}

function checkSavedLogin() {
  const token = localStorage.getItem('gsi_token');
  if (!token) return;
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    // Check expiry
    if (payload.exp * 1000 < Date.now()) {
      localStorage.removeItem('gsi_token');
      return;
    }
    currentUser = { name: payload.name, picture: payload.picture, email: payload.email };
    updateUserUI();
  } catch { localStorage.removeItem('gsi_token'); }
}

function updateUserUI() {
  if (!currentUser) return;
  // Intro nav: hide login button, show profile
  const loginBtn = document.getElementById('loginBtnIntro');
  const profile = document.getElementById('userProfileIntro');
  if (loginBtn) loginBtn.classList.add('hidden');
  const dropdown = document.getElementById('googleLoginDropdown');
  if (dropdown) dropdown.classList.add('hidden');
  if (profile) {
    profile.classList.remove('hidden');
    document.getElementById('userAvatarIntro').src = currentUser.picture || '';
    document.getElementById('userNameIntro').textContent = currentUser.name || '';
  }
  // Sidebar avatars
  document.querySelectorAll('.sidebar-avatar').forEach(el => {
    const icon = el.querySelector('.sidebar-avatar-icon');
    const img = el.querySelector('.sidebar-avatar-img');
    if (icon && img && currentUser.picture) {
      icon.classList.add('hidden');
      img.src = currentUser.picture;
      img.classList.remove('hidden');
    }
  });
}

function toggleUserMenu() {
  if (confirm('로그아웃하시겠습니까?')) {
    localStorage.removeItem('gsi_token');
    currentUser = null;
    location.reload();
  }
}

function requireLogin() {
  if (currentUser) return true;
  onLoginClick();
  return false;
}

// ---- Screen Management ----
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screenMap = { intro: 'introScreen', upload: 'uploadScreen', loading: 'loadingScreen', result: 'resultScreen' };
  const el = document.getElementById(screenMap[name]);
  if (el) el.classList.add('active');

  // Theme switch
  if (name === 'intro' || name === 'upload') {
    document.body.className = 'bg-[#0a0a0f] text-white min-h-screen';
  } else {
    document.body.className = 'bg-gray-50 text-gray-900 min-h-screen';
  }
}

// ---- File Handling ----
function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) {
    if (!requireLogin()) { e.target.value = ''; return; }
    uploadFile(file);
  }
}

// Drag and drop
document.addEventListener('DOMContentLoaded', () => {
  checkSavedLogin();
  initGoogleLogin();

  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('googleLoginDropdown');
    const loginBtn = document.getElementById('loginBtnIntro');
    if (dropdown && loginBtn && !loginBtn.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });

  const dropArea = document.getElementById('dropArea');
  if (!dropArea) return;
  ['dragenter','dragover'].forEach(ev => {
    dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropArea.classList.add('border-indigo-500/50','bg-white/[0.06]'); });
  });
  ['dragleave','drop'].forEach(ev => {
    dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('border-indigo-500/50','bg-white/[0.06]'); });
  });
  dropArea.addEventListener('drop', e => {
    const file = e.dataTransfer.files[0];
    if (file) {
      if (!requireLogin()) return;
      uploadFile(file);
    }
  });
});

// ---- Upload ----
async function uploadFile(file) {
  isDemoMode = false;
  uploadedFileUrl = URL.createObjectURL(file);
  uploadedFileType = file.type;

  loadingStartTime = Date.now();
  showScreen('loading');
  animateLoading();

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch('/api/analyze', { method: 'POST', body: formData });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    analysisData = data;
    renderResults(data, file.name);
  } catch (err) {
    console.error('Upload failed:', err);
    try {
      const res2 = await fetch('/static/fallback.json');
      const data2 = await res2.json();
      analysisData = data2;
      renderResults(data2, file.name);
    } catch {
      alert('분석에 실패했습니다. 잠시 후 다시 시도해주세요.');
      showScreen('upload');
    }
  }
}

// ---- Demo ----
async function loadDemo() {
  isDemoMode = true;
  uploadedFileUrl = null;
  uploadedFileType = null;

  loadingStartTime = Date.now();
  showScreen('loading');
  animateLoading();

  try {
    const res = await fetch('/api/demo');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    analysisData = data;
    renderResults(data, '[데모] 주택임대차계약서 샘플');
  } catch {
    try {
      const res2 = await fetch('/static/fallback.json');
      const data2 = await res2.json();
      analysisData = data2;
      renderResults(data2, '[데모] 주택임대차계약서 샘플');
    } catch {
      alert('데모 데이터를 불러올 수 없습니다.');
      showScreen('intro');
    }
  }
}

// ---- Loading Animation ----
function animateLoading() {
  const bar = document.getElementById('progressBar');
  const statusText = document.getElementById('loadingStatusText');
  if (!bar) return;
  bar.style.width = '0%';
  const steps = [
    { pct: 20, text: '계약서를 읽고 있습니다...' },
    { pct: 45, text: '조항을 추출하고 있습니다...' },
    { pct: 65, text: '표준 계약서와 비교 중...' },
    { pct: 80, text: '위험 요소를 분석하는 중...' },
    { pct: 92, text: '행동 스크립트를 생성하는 중...' },
  ];
  steps.forEach((s, i) => {
    setTimeout(() => {
      bar.style.width = s.pct + '%';
      if (statusText) statusText.textContent = s.text;
    }, (i + 1) * 400);
  });
}

// ---- File Preview ----
function renderFilePreview() {
  const section = document.getElementById('filePreviewSection');
  const content = document.getElementById('filePreviewContent');
  const demoBanner = document.getElementById('demoBanner');
  const demoTag = document.getElementById('resultDemoTag');

  if (isDemoMode) {
    section.classList.add('hidden');
    demoBanner.classList.remove('hidden');
    demoTag.classList.remove('hidden');
  } else {
    demoBanner.classList.add('hidden');
    demoTag.classList.add('hidden');
    if (uploadedFileUrl) {
      section.classList.remove('hidden');
      content.innerHTML = '';
      if (uploadedFileType === 'application/pdf') {
        content.innerHTML = `<iframe src="${uploadedFileUrl}" class="w-full h-full border-0" title="원본 PDF"></iframe>`;
      } else if (uploadedFileType && uploadedFileType.startsWith('image/')) {
        content.innerHTML = `<img src="${uploadedFileUrl}" class="max-h-full max-w-full object-contain p-2" alt="원본 이미지"/>`;
      } else {
        content.innerHTML = `<div class="text-gray-400 text-sm flex items-center gap-2"><span class="material-symbols-outlined">description</span>파일 미리보기를 지원하지 않는 형식입니다</div>`;
      }
    } else {
      section.classList.add('hidden');
    }
  }
}

function toggleFilePreview() {
  const container = document.getElementById('filePreviewContainer');
  const icon = document.getElementById('filePreviewToggleIcon');
  filePreviewOpen = !filePreviewOpen;
  if (filePreviewOpen) {
    container.style.maxHeight = '200px';
    icon.textContent = 'expand_more';
  } else {
    container.style.maxHeight = '0';
    icon.textContent = 'chevron_right';
  }
}

// ---- Render Results ----
function renderResults(data, filename) {
  const elapsed = Date.now() - loadingStartTime;
  const minDelay = 2000;
  const remaining = Math.max(0, minDelay - elapsed);

  setTimeout(() => {
    // Top bar
    document.getElementById('resultFileName').textContent = filename || '계약서';
    const badge = document.getElementById('resultRiskBadge');
    const rl = data.summary?.riskLevel || 'high';
    if (rl === 'high') { badge.textContent = '위험'; badge.className = 'px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600'; }
    else if (rl === 'medium') { badge.textContent = '주의'; badge.className = 'px-2.5 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-600'; }
    else { badge.textContent = '안전'; badge.className = 'px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-600'; }

    // Summary cards
    document.getElementById('summaryRiskCount').textContent = data.summary?.deviatedClauseCount || 0;
    document.getElementById('summaryTotalCount').textContent = data.summary?.totalClauseCount || 0;
    const maxRisk = data.summary?.totalMaxRisk || 0;
    document.getElementById('summaryMaxRisk').textContent = '\u20A9' + maxRisk.toLocaleString();

    // File preview / demo banner
    renderFilePreview();

    // Render contract clauses (Grammarly annotation view)
    renderContractDocument(data);

    // Render checklist
    renderChecklist(data);

    // Overall action
    if (data.overallAction) {
      document.getElementById('overallActionBox').classList.remove('hidden');
      document.getElementById('overallActionText').textContent = data.overallAction.message;
    }

    // Charts
    renderDeviationChart(data);
    renderRiskChart(data);

    // Show result
    showScreen('result');
    closePanelDetail();
  }, remaining);
}

// ---- Merge & Sort Clauses ----
function mergeAndSortClauses(data) {
  const allClauses = [];

  // Safe clauses
  (data.safeClausesSummary || []).forEach(sc => {
    allClauses.push({
      number: sc.number, title: sc.title,
      deviationScore: sc.deviationScore, status: sc.status,
      body: sc.body || '', isRisk: false,
    });
  });

  // Risk clauses
  (data.clauses || []).forEach((c, idx) => {
    allClauses.push({ ...c, isRisk: true, riskIdx: idx });
  });

  // Sort by clause number
  allClauses.sort((a, b) => {
    const numA = parseInt((a.number || '').replace(/[^0-9]/g, '')) || 0;
    const numB = parseInt((b.number || '').replace(/[^0-9]/g, '')) || 0;
    return numA - numB;
  });

  return allClauses;
}

// ---- Contract Document Viewer (Grammarly Annotation Style) ----
function renderContractDocument(data) {
  const container = document.getElementById('clauseList');
  container.innerHTML = '';

  const allClauses = mergeAndSortClauses(data);

  allClauses.forEach((clause) => {
    const div = document.createElement('div');
    const clauseNum = (clause.number || '').replace(/[^0-9]/g, '');
    div.id = `clause-${clauseNum}`;

    if (clause.isRisk) {
      const level = clause.deviationScore >= 80 ? 'danger' : 'caution';
      const bgColor = level === 'danger' ? 'bg-red-500' : 'bg-amber-500';
      const tooltipText = clause.easyKorean?.level1 || '';

      div.className = `annotation-${level} rounded-lg p-4 mb-3 pr-12 relative`;
      div.setAttribute('data-idx', clause.riskIdx);
      div.onclick = () => openDetail(clause.riskIdx);
      div.innerHTML = `
        <div class="flex items-center gap-2 mb-2">
          <span class="font-bold text-gray-900">${clause.number}</span>
          <span class="font-medium text-gray-700">${clause.title}</span>
          <span class="px-2 py-0.5 rounded text-[10px] font-bold ${level === 'danger' ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-600'}">
            ${level === 'danger' ? '위험' : '주의'} ${clause.deviationScore}%
          </span>
        </div>
        <p class="text-sm text-gray-700 leading-relaxed serif-text">${clause.body || clause.original || ''}</p>
        <!-- Margin marker -->
        <div class="annotation-marker ${bgColor} text-white">${clause.riskIdx + 1}</div>
        <!-- Hover tooltip -->
        ${tooltipText ? `<div class="annotation-tooltip">${tooltipText}</div>` : ''}
      `;
    } else {
      div.className = 'p-4 mb-3 border-l-2 border-transparent hover:border-gray-200 transition-colors rounded-lg';
      div.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <span class="font-bold text-gray-900 text-sm">${clause.number}</span>
          <span class="font-medium text-gray-600 text-sm">${clause.title}</span>
          <span class="text-[10px] px-1.5 py-0.5 rounded ${clause.status === 'caution' ? 'bg-amber-50 text-amber-500' : 'bg-green-50 text-green-500'}">
            ${clause.status === 'caution' ? '주의' : '안전'}
          </span>
        </div>
        ${clause.body ? `<p class="text-sm text-gray-500 leading-relaxed serif-text">${clause.body}</p>` : ''}
      `;
    }

    container.appendChild(div);
  });
}

// ---- Scroll to Clause (from checklist) ----
function scrollToClause(clauseNumber) {
  const num = (clauseNumber || '').replace(/[^0-9]/g, '');
  const el = document.getElementById(`clause-${num}`);
  if (el) {
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    el.classList.add('clause-pulse');
    setTimeout(() => el.classList.remove('clause-pulse'), 2000);
  }
}

// ---- Checklist ----
function renderChecklist(data) {
  const container = document.getElementById('checklistItems');
  container.innerHTML = '';
  (data.clauses || []).forEach((c, idx) => {
    const isUrgent = c.action?.priority === 'urgent';
    const div = document.createElement('div');
    div.className = 'p-3 rounded-xl border cursor-pointer transition-all hover:shadow-sm ' +
      (isUrgent ? 'border-red-200 bg-red-50 hover:bg-red-100' : 'border-amber-200 bg-amber-50 hover:bg-amber-100');
    div.onclick = () => {
      scrollToClause(c.number);
      openDetail(idx);
    };
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-base ${isUrgent ? 'text-red-500' : 'text-amber-500'}">${isUrgent ? 'error' : 'warning'}</span>
          <span class="text-sm font-medium text-gray-800">${c.number} ${c.title}</span>
        </div>
        <span class="material-symbols-outlined text-gray-400 text-base">chevron_right</span>
      </div>
      <p class="text-xs text-gray-500 mt-1 ml-7">${c.easyKorean?.level1 || ''}</p>
    `;
    container.appendChild(div);
  });
}

// ---- Open Detail Panel ----
function openDetail(idx) {
  const clause = analysisData?.clauses?.[idx];
  if (!clause) return;
  currentClauseIdx = idx;
  currentTabLevel = 1;

  // Highlight active clause in annotation view
  document.querySelectorAll('[data-idx]').forEach(el => {
    const isActive = parseInt(el.dataset.idx) === idx;
    el.classList.toggle('ring-2', isActive);
    el.classList.toggle('ring-indigo-400', isActive);
  });

  // Fill detail panel
  document.getElementById('detailNumber').textContent = clause.number;
  document.getElementById('detailTitle').textContent = clause.title;

  const badge = document.getElementById('detailBadge');
  const score = clause.deviationScore || 0;
  if (score >= 80) { badge.textContent = '위험'; badge.className = 'px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-600'; }
  else if (score >= 50) { badge.textContent = '주의'; badge.className = 'px-2 py-0.5 rounded text-xs font-bold bg-amber-100 text-amber-600'; }
  else { badge.textContent = '안전'; badge.className = 'px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-600'; }

  document.getElementById('detailScore').textContent = score + '%';
  const bar = document.getElementById('detailScoreBar');
  bar.style.width = score + '%';
  bar.className = 'h-full rounded-full transition-all duration-500 ' +
    (score >= 80 ? 'bg-red-500' : score >= 50 ? 'bg-amber-500' : 'bg-green-500');

  document.getElementById('detailDirection').textContent = clause.direction || '';
  document.getElementById('detailOriginal').textContent = clause.original || '';
  document.getElementById('detailStandard').textContent = clause.standard || '';
  document.getElementById('detailActionMessage').textContent = clause.action?.message || '';

  // Action box color
  const actionBox = document.getElementById('detailActionBox');
  if (clause.action?.type === 'danger') {
    actionBox.className = 'bg-red-50 border border-red-200 rounded-xl p-4';
    actionBox.querySelector('h4').className = 'text-sm font-bold text-red-700 mb-2 flex items-center gap-1.5';
    actionBox.querySelector('p').className = 'text-sm text-red-800 whitespace-pre-line leading-relaxed';
  } else {
    actionBox.className = 'bg-amber-50 border border-amber-200 rounded-xl p-4';
    actionBox.querySelector('h4').className = 'text-sm font-bold text-amber-700 mb-2 flex items-center gap-1.5';
    actionBox.querySelector('p').className = 'text-sm text-amber-800 whitespace-pre-line leading-relaxed';
  }

  // Tab content
  switchTab(1);

  // Show detail panel, hide default
  document.getElementById('panelDefault').classList.add('hidden');
  document.getElementById('panelDetail').classList.remove('hidden');
}

function closePanelDetail() {
  document.getElementById('panelDefault').classList.remove('hidden');
  document.getElementById('panelDetail').classList.add('hidden');
  document.querySelectorAll('[data-idx]').forEach(el => {
    el.classList.remove('ring-2', 'ring-indigo-400');
  });
  currentClauseIdx = -1;
}

// ---- Easy Korean Tabs ----
function switchTab(level) {
  currentTabLevel = level;
  const clause = analysisData?.clauses?.[currentClauseIdx];
  if (!clause) return;

  const content = document.getElementById('easyKoreanContent');
  const levels = { 1: clause.easyKorean?.level1, 2: clause.easyKorean?.level2, 3: clause.easyKorean?.level3 };
  content.textContent = levels[level] || '';

  // Update tab styles
  const tabs = document.querySelectorAll('#panelDetail .tab-btn');
  tabs.forEach((t, i) => {
    if (i + 1 === level) {
      t.className = 'tab-btn active-tab text-sm font-medium text-indigo-600';
    } else {
      t.className = 'tab-btn text-sm font-medium text-gray-400 hover:text-gray-600';
    }
  });
}

// ---- Charts ----
function renderDeviationChart(data) {
  const ctx = document.getElementById('deviationChart');
  if (!ctx) return;
  if (deviationChartInstance) deviationChartInstance.destroy();

  const clauses = data.clauses || [];
  deviationChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: clauses.map(c => c.number),
      datasets: [{
        label: '이탈도 (%)',
        data: clauses.map(c => c.deviationScore),
        backgroundColor: clauses.map(c => c.deviationScore >= 80 ? '#EF4444' : c.deviationScore >= 50 ? '#F59E0B' : '#10B981'),
        borderRadius: 6,
        barThickness: 28,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, max: 100, ticks: { font: { size: 11 } }, grid: { color: '#f3f4f6' } },
        x: { ticks: { font: { size: 11 } }, grid: { display: false } },
      }
    }
  });
}

function renderRiskChart(data) {
  const ctx = document.getElementById('riskChart');
  if (!ctx) return;
  if (riskChartInstance) riskChartInstance.destroy();

  const clauses = data.clauses || [];
  const safe = (data.safeClausesSummary || []).length;
  const danger = clauses.filter(c => c.deviationScore >= 80).length;
  const caution = clauses.filter(c => c.deviationScore < 80).length;

  riskChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['위험', '주의', '안전'],
      datasets: [{
        data: [danger, caution, safe],
        backgroundColor: ['#EF4444', '#F59E0B', '#10B981'],
        borderWidth: 0,
        spacing: 2,
      }]
    },
    options: {
      responsive: true,
      cutout: '65%',
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 12 }, padding: 16, usePointStyle: true, pointStyleWidth: 10 } }
      }
    }
  });
}

// ---- Copy Action ----
function copyAction() {
  const text = document.getElementById('detailActionMessage')?.textContent || '';
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('#detailActionBox button');
    const orig = btn.innerHTML;
    btn.innerHTML = '<span class="material-symbols-outlined text-sm">check</span> 복사됨!';
    setTimeout(() => { btn.innerHTML = orig; }, 1500);
  });
}

// ---- Keyboard ----
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (currentClauseIdx >= 0) closePanelDetail();
  }
});
</script>

</body>
</html>
