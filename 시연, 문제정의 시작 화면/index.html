<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ClearSign — 임대차 계약서 위험 분석 AI</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      keyframes: {
        scan: {
          '0%': { top: '0%', opacity: '0' },
          '10%': { opacity: '1' },
          '90%': { opacity: '1' },
          '100%': { top: '100%', opacity: '0' },
        },
        'pulse-ring': {
          '0%': { transform: 'scale(0.8)', opacity: '0.5' },
          '100%': { transform: 'scale(2)', opacity: '0' },
        },
        shimmer: {
          '0%': { transform: 'translateX(-100%) skewX(-12deg)' },
          '100%': { transform: 'translateX(200%) skewX(-12deg)' },
        },
        'bounce-dot': {
          '0%, 80%, 100%': { transform: 'translateY(0)' },
          '40%': { transform: 'translateY(-6px)' },
        },
      },
      animation: {
        scan: 'scan 2s cubic-bezier(0.4,0,0.2,1) infinite',
        'pulse-ring': 'pulse-ring 2s cubic-bezier(0.215,0.61,0.355,1) infinite',
        shimmer: 'shimmer 1.5s infinite',
        'bounce-dot': 'bounce-dot 1.4s infinite ease-in-out both',
      },
    }
  }
}
</script>
<style>
  :root {
    --primary-indigo: #4F46E5;
    --primary-indigo-hover: #4338CA;
    --bg-dark: #0a0a0f;
    --card-dark: #13131f;
    --border-dark: #2a2a3a;
    --text-muted: #9ca3af;
    --risk-high: #EF4444;
    --safe-green: #10B981;
    /* Light theme defaults */
    --bg-primary: #f9fafb;
    --bg-secondary: #ffffff;
    --bg-card: #ffffff;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    --sidebar-bg: #ffffff;
    --sidebar-border: #e5e7eb;
    --hover-bg: rgba(0,0,0,0.03);
  }
  [data-theme="dark"] {
    --bg-primary: #0a0a0f;
    --bg-secondary: #13131f;
    --bg-card: #1a1a2e;
    --text-primary: #f9fafb;
    --text-secondary: #d1d5db;
    --text-muted: #6b7280;
    --border-color: #2a2a3a;
    --sidebar-bg: #0a0a0f;
    --sidebar-border: #2a2a3a;
    --hover-bg: rgba(255,255,255,0.05);
  }
  body {
    font-family: 'Noto Sans KR', sans-serif;
    transition: background-color 0.4s ease, color 0.4s ease;
  }
  .serif-text { font-family: 'Noto Serif KR', serif; }
  .scrambled-text { filter: blur(0.5px); opacity: 0.7; }
  .glass-panel {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-dark);
  }
  .screen { display: none; }
  .screen.active { display: flex; }
  /* scan-line for loading */
  .scan-line {
    animation: scan 2s cubic-bezier(0.4,0,0.2,1) infinite;
    background: linear-gradient(to bottom, transparent, var(--primary-indigo), transparent);
    box-shadow: 0 0 15px var(--primary-indigo);
  }
  /* risk highlight */
  .clause-risk-highlight {
    background: rgba(239,68,68,0.08);
    border-left: 3px solid #EF4444;
    cursor: pointer;
    transition: background 0.2s;
  }
  .clause-risk-highlight:hover { background: rgba(239,68,68,0.14); }
  .clause-risk-highlight.active { background: rgba(239,68,68,0.18); }
  .clause-safe { border-left: 3px solid transparent; padding-left: 16px; }
  /* scrollbar */
  .custom-scroll::-webkit-scrollbar { width: 6px; }
  .custom-scroll::-webkit-scrollbar-track { background: transparent; }
  .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
  .dark-scroll::-webkit-scrollbar-thumb { background: #374151; }
  /* tab underline */
  .tab-btn { position: relative; padding-bottom: 8px; }
  .tab-btn.active-tab::after {
    content: '';
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 2px; background: var(--primary-indigo); border-radius: 1px;
  }
  /* progress shimmer */
  .progress-shimmer {
    position: relative; overflow: hidden;
  }
  .progress-shimmer::after {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    animation: shimmer 1.5s infinite;
  }

  /* Grammarly-style annotation: danger */
  .annotation-danger {
    background: linear-gradient(to bottom, transparent 60%, rgba(239,68,68,0.12) 60%);
    text-decoration: underline wavy #EF4444;
    text-decoration-skip-ink: none;
    text-underline-offset: 4px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }
  .annotation-danger:hover {
    background: linear-gradient(to bottom, transparent 50%, rgba(239,68,68,0.18) 50%);
  }
  /* Grammarly-style annotation: caution */
  .annotation-caution {
    background: linear-gradient(to bottom, transparent 60%, rgba(245,158,11,0.10) 60%);
    text-decoration: underline wavy #F59E0B;
    text-decoration-skip-ink: none;
    text-underline-offset: 4px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }
  .annotation-caution:hover {
    background: linear-gradient(to bottom, transparent 50%, rgba(245,158,11,0.16) 50%);
  }
  /* Margin marker badge */
  .annotation-marker {
    position: absolute; right: -36px; top: 8px;
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: transform 0.15s;
  }
  .annotation-marker:hover { transform: scale(1.15); }
  /* Hover tooltip */
  .annotation-tooltip {
    position: absolute; bottom: calc(100% + 8px); left: 50%;
    transform: translateX(-50%);
    background: #1f2937; color: #fff;
    padding: 8px 14px; border-radius: 10px;
    font-size: 13px; line-height: 1.5;
    max-width: 320px; white-space: normal;
    opacity: 0; transition: opacity 0.2s;
    pointer-events: none; z-index: 30;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  }
  .annotation-tooltip::after {
    content: ''; position: absolute; top: 100%; left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent; border-top-color: #1f2937;
  }
  .annotation-danger:hover .annotation-tooltip,
  .annotation-caution:hover .annotation-tooltip { opacity: 1; }
  /* Pulse highlight for scroll-to */
  @keyframes clause-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(99,102,241,0.4); }
    50% { box-shadow: 0 0 0 6px rgba(99,102,241,0); }
  }
  .clause-pulse { animation: clause-pulse 0.8s ease-out 2; }
  /* Demo banner */
  .demo-banner {
    background: linear-gradient(135deg, #EEF2FF, #E0E7FF);
    border: 1px dashed #818CF8;
  }
  /* File preview collapse */
  .file-preview-container { transition: max-height 0.3s ease; overflow: hidden; }

  /* ===== Unified Sidebar ===== */
  #unifiedSidebar {
    background: var(--sidebar-bg);
    border-right: 1px solid var(--sidebar-border);
    transition: background 0.3s, border-color 0.3s;
  }
  .sidebar-nav-btn {
    color: var(--text-muted);
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .sidebar-nav-btn:hover {
    background: var(--hover-bg);
    color: var(--text-secondary);
  }
  .sidebar-nav-btn.active {
    background: rgba(79,70,229,0.1);
    color: var(--primary-indigo);
    border-color: rgba(79,70,229,0.2);
  }

  /* ===== Settings Toggle Switch ===== */
  .settings-toggle {
    position: relative;
    width: 48px;
    height: 26px;
    background: #d1d5db;
    border-radius: 13px;
    cursor: pointer;
    transition: background 0.3s;
    flex-shrink: 0;
  }
  .settings-toggle::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.3s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .settings-toggle.active {
    background: var(--primary-indigo);
  }
  .settings-toggle.active::after {
    transform: translateX(22px);
  }

  /* ===== Settings Range Slider ===== */
  .settings-range {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
  }
  .settings-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--primary-indigo);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(79,70,229,0.4);
  }
  .settings-range::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--primary-indigo);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 1px 4px rgba(79,70,229,0.4);
  }
  [data-theme="dark"] .settings-range {
    background: #374151;
  }

  /* ===== High Contrast Mode ===== */
  [data-high-contrast="true"] {
    --text-primary: #000000;
    --text-secondary: #1a1a1a;
    --text-muted: #333333;
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-card: #ffffff;
    --border-color: #000000;
  }
  [data-high-contrast="true"][data-theme="dark"] {
    --text-primary: #ffffff;
    --text-secondary: #f0f0f0;
    --text-muted: #cccccc;
    --bg-primary: #000000;
    --bg-secondary: #0a0a0a;
    --bg-card: #111111;
    --border-color: #ffffff;
  }

  /* ===== Slide Panels ===== */
  .slide-panel {
    position: fixed;
    top: 0;
    left: 80px;
    height: 100%;
    width: min(320px, calc(100vw - 80px - 1rem));
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-color);
    transform: translateX(-400px);
    transition: transform 0.3s ease;
    z-index: 35;
    overflow-y: auto;
  }
  .slide-panel.open { transform: translateX(0); }
  .slide-panel-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 34;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .slide-panel-backdrop.open {
    opacity: 1;
    pointer-events: auto;
  }

  /* ===== Login Modal ===== */
  .login-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 60;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .login-modal-overlay.open { display: flex; }
  .login-modal-box {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 1.5rem;
    padding: 2.5rem;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
  }

  /* ===== Dark mode overrides: Loading Screen ===== */
  [data-theme="dark"] #loadingScreen > main { background: #0a0a0f !important; }
  [data-theme="dark"] #loadingScreen .bg-gray-50 { background: #13131f !important; }
  [data-theme="dark"] #loadingScreen .bg-white { background: #1a1a2e !important; }
  [data-theme="dark"] #loadingScreen .text-gray-900 { color: #f9fafb !important; }
  [data-theme="dark"] #loadingScreen .text-gray-500 { color: #d1d5db !important; }
  [data-theme="dark"] #loadingScreen .border-gray-100,
  [data-theme="dark"] #loadingScreen .border-gray-200 { border-color: #2a2a3a !important; }
  [data-theme="dark"] #loadingScreen .bg-gray-100 { background: rgba(255,255,255,0.08) !important; }
  [data-theme="dark"] #loadingScreen .bg-gray-200 { background: rgba(255,255,255,0.1) !important; }
  [data-theme="dark"] #loadingScreen .bg-indigo-50 { background: rgba(79,70,229,0.1) !important; }
  [data-theme="dark"] #loadingScreen .border-indigo-100 { border-color: rgba(79,70,229,0.2) !important; }
  [data-theme="dark"] #loadingScreen .bg-indigo-200 { background: rgba(79,70,229,0.2) !important; }
  [data-theme="dark"] #loadingScreen .bg-blue-100 { background: rgba(59,130,246,0.1) !important; }
  [data-theme="dark"] #loadingScreen .shadow-xl { box-shadow: 0 20px 25px rgba(0,0,0,0.4) !important; }
  [data-theme="dark"] #loadingScreen .border-indigo-50 { border-color: rgba(79,70,229,0.15) !important; }

  /* ===== Dark mode overrides: Result Screen ===== */
  [data-theme="dark"] #resultScreen > main { background: #0a0a0f !important; }
  [data-theme="dark"] #resultScreen .bg-gray-50 { background: #13131f !important; }
  [data-theme="dark"] #resultScreen .bg-white { background: #1a1a2e !important; }
  [data-theme="dark"] #resultScreen .text-gray-900 { color: #f9fafb !important; }
  [data-theme="dark"] #resultScreen .text-gray-800 { color: #e5e7eb !important; }
  [data-theme="dark"] #resultScreen .text-gray-700 { color: #d1d5db !important; }
  [data-theme="dark"] #resultScreen .text-gray-600 { color: #d1d5db !important; }
  [data-theme="dark"] #resultScreen .text-gray-500 { color: #9ca3af !important; }
  [data-theme="dark"] #resultScreen .text-gray-400 { color: #6b7280 !important; }
  [data-theme="dark"] #resultScreen .border-gray-200 { border-color: #2a2a3a !important; }
  [data-theme="dark"] #resultScreen .border-gray-100 { border-color: rgba(255,255,255,0.08) !important; }
  [data-theme="dark"] #resultScreen .bg-gray-100 { background: rgba(255,255,255,0.06) !important; }
  [data-theme="dark"] #resultScreen .custom-scroll::-webkit-scrollbar-thumb { background: #374151; }
  [data-theme="dark"] #resultScreen .bg-indigo-50\/50,
  [data-theme="dark"] #resultScreen .bg-indigo-50 { background: rgba(79,70,229,0.08) !important; }
  [data-theme="dark"] #resultScreen .border-indigo-100 { border-color: rgba(79,70,229,0.2) !important; }
  [data-theme="dark"] #resultScreen .text-indigo-600 { color: #818CF8 !important; }
  [data-theme="dark"] #resultScreen .bg-red-50 { background: rgba(239,68,68,0.08) !important; }
  [data-theme="dark"] #resultScreen .border-red-200,
  [data-theme="dark"] #resultScreen .border-red-100 { border-color: rgba(239,68,68,0.2) !important; }
  [data-theme="dark"] #resultScreen .text-red-700 { color: #FCA5A5 !important; }
  [data-theme="dark"] #resultScreen .text-red-600 { color: #F87171 !important; }
  [data-theme="dark"] #resultScreen .text-red-800 { color: #FCA5A5 !important; }
  [data-theme="dark"] #resultScreen .bg-green-50 { background: rgba(16,185,129,0.08) !important; }
  [data-theme="dark"] #resultScreen .border-green-100 { border-color: rgba(16,185,129,0.2) !important; }
  [data-theme="dark"] #resultScreen .bg-amber-50 { background: rgba(245,158,11,0.08) !important; }
  [data-theme="dark"] #resultScreen .border-amber-200 { border-color: rgba(245,158,11,0.2) !important; }
  [data-theme="dark"] #resultScreen .text-amber-700 { color: #FCD34D !important; }
  [data-theme="dark"] #resultScreen .text-amber-800 { color: #FDE68A !important; }
  [data-theme="dark"] #resultScreen .bg-purple-50\/50 { background: rgba(139,92,246,0.08) !important; }
  [data-theme="dark"] #resultScreen .border-purple-100 { border-color: rgba(139,92,246,0.2) !important; }
  [data-theme="dark"] #resultScreen .demo-banner { background: rgba(79,70,229,0.1) !important; border-color: rgba(129,140,248,0.3) !important; }
  [data-theme="dark"] #resultScreen .demo-banner .text-indigo-700 { color: #A5B4FC !important; }
  [data-theme="dark"] #resultScreen .demo-banner .text-indigo-500 { color: #818CF8 !important; }

  /* ===== Light mode overrides: Upload Screen ===== */
  [data-theme="light"] #uploadScreen { background: #f9fafb !important; }
  [data-theme="light"] #uploadScreen > main { background: #f9fafb !important; }
  [data-theme="light"] #uploadScreen .text-white:not(.bg-\[var\(--primary-indigo\)\] *) { color: #111827 !important; }
  [data-theme="light"] #uploadScreen h1 { background-image: linear-gradient(to right, #111827, #6b7280) !important; -webkit-background-clip: text !important; }
  [data-theme="light"] #uploadScreen .text-gray-400 { color: #6b7280 !important; }
  [data-theme="light"] #uploadScreen .text-gray-500 { color: #9ca3af !important; }
  [data-theme="light"] #uploadScreen .text-gray-300 { color: #374151 !important; }
  [data-theme="light"] #uploadScreen .text-gray-200 { color: #374151 !important; }
  [data-theme="light"] #uploadScreen .glass-panel {
    background: rgba(0,0,0,0.02) !important;
    border-color: #e5e7eb !important;
    backdrop-filter: blur(10px);
  }
  [data-theme="light"] #uploadScreen .bg-\[\#1a1a24\] { background: #e5e7eb !important; }
  [data-theme="light"] #uploadScreen .border-\[\#2a2a3a\] { border-color: #e5e7eb !important; }
  [data-theme="light"] #uploadScreen .bg-indigo-900\/20,
  [data-theme="light"] #uploadScreen .bg-indigo-600\/10,
  [data-theme="light"] #uploadScreen .bg-indigo-900\/10 { opacity: 0.3 !important; }
</style>
</head>

<body class="bg-[#0a0a0f] text-white min-h-screen">

<!-- ============================================================ -->
<!-- SCREEN 1: INTRO (dark, no sidebar)                            -->
<!-- ============================================================ -->
<div id="introScreen" class="screen active h-screen w-full flex-col items-center justify-center relative overflow-hidden bg-[#0a0a0f] text-white">
  <!-- BG blurs -->
  <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
    <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-900/20 rounded-full blur-[120px]"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-600/10 rounded-full blur-[120px]"></div>
  </div>
  <!-- Nav -->
  <nav class="absolute top-0 left-0 w-full p-8 flex justify-between items-center z-20">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-[var(--primary-indigo)] rounded-lg flex items-center justify-center text-white">
        <span class="material-symbols-outlined text-xl">assignment_turned_in</span>
      </div>
      <span class="font-bold text-xl tracking-tight">ClearSign</span>
    </div>
    <div class="hidden md:flex gap-6 text-sm text-gray-400 items-center">
      <a class="hover:text-white transition-colors cursor-pointer" onclick="showScreen('upload')">서비스 소개</a>
      <a class="hover:text-white transition-colors cursor-pointer">요금제</a>
      <!-- Google Login / User Profile -->
      <div id="loginBtnIntro" class="relative">
        <button onclick="onLoginClick()" class="hover:text-white transition-colors flex items-center gap-1.5">
          <span class="material-symbols-outlined text-lg">person</span>
          로그인
        </button>
        <div id="googleLoginDropdown" class="hidden absolute right-0 top-10 bg-[#1a1a2e] border border-indigo-500/30 rounded-xl p-4 shadow-2xl min-w-[240px] z-50">
          <p class="text-xs text-gray-400 mb-3">Google 계정으로 로그인</p>
          <div id="googleBtnContainer"></div>
          <p id="loginUnavailableMsg" class="hidden text-xs text-red-400 mt-2">Google 로그인을 사용할 수 없습니다.</p>
        </div>
      </div>
      <div id="userProfileIntro" class="hidden flex items-center gap-2 cursor-pointer" onclick="toggleUserMenu()">
        <img id="userAvatarIntro" class="w-8 h-8 rounded-full border border-indigo-500/30" src="" alt=""/>
        <span id="userNameIntro" class="text-white text-sm font-medium"></span>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <main class="relative z-10 w-full max-w-5xl px-6 flex flex-col md:flex-row items-center gap-12 lg:gap-20 m-auto">
    <!-- Left: Text -->
    <div class="flex-1 space-y-8 text-center md:text-left">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-900/30 border border-indigo-500/30 text-indigo-300 text-xs font-medium mb-2">
        <span class="w-2 h-2 rounded-full bg-indigo-400 animate-pulse"></span>
        AI 수어 통역 엔진 v2.0
      </div>
      <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold leading-tight tracking-tight">
        계약서, <br/>
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-indigo-200">이제 보이는 언어로</span> <br/>
        확인하세요.
      </h1>
      <p class="text-gray-400 text-lg md:text-xl font-light leading-relaxed max-w-lg mx-auto md:mx-0">
        복잡한 법률 용어와 숨겨진 독소 조항, <br/>
        ClearSign이 당신의 모국어인 수어와 쉬운 그림으로 <br/>
        직관적이고 명확하게 보여드립니다.
      </p>
      <div class="pt-4 flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
        <button onclick="showScreen('upload')" class="group relative px-8 py-4 bg-[var(--primary-indigo)] hover:bg-[var(--primary-indigo-hover)] text-white rounded-full shadow-[0_0_20px_rgba(79,70,229,0.3)] hover:shadow-[0_0_30px_rgba(79,70,229,0.5)] transition-all flex items-center justify-center gap-3 font-medium text-lg overflow-hidden">
          <span class="relative z-10">내 계약서 분석하기</span>
          <span class="material-symbols-outlined relative z-10 group-hover:translate-x-1 transition-transform">arrow_forward</span>
          <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out skew-y-12"></div>
        </button>
        <button onclick="loadDemo()" class="px-8 py-4 bg-white/5 hover:bg-white/10 border border-white/10 text-white rounded-full transition-all flex items-center justify-center gap-2 backdrop-blur-sm">
          <span class="material-symbols-outlined">play_circle</span>
          <span>작동 원리 보기</span>
        </button>
      </div>
      <div class="pt-8 flex items-center gap-4 justify-center md:justify-start opacity-60">
        <div class="flex -space-x-3">
          <div class="w-10 h-10 rounded-full border-2 border-[var(--bg-dark)] bg-gray-700"></div>
          <div class="w-10 h-10 rounded-full border-2 border-[var(--bg-dark)] bg-gray-600"></div>
          <div class="w-10 h-10 rounded-full border-2 border-[var(--bg-dark)] bg-gray-500"></div>
        </div>
        <p class="text-sm text-gray-400">
          <span class="font-bold text-white">1,204명</span>이 오늘 안전하게 계약했습니다
        </p>
      </div>
    </div>

    <!-- Right: Contract Card -->
    <div class="flex-1 w-full max-w-md md:max-w-full">
      <div class="relative group">
        <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
        <div class="relative bg-[var(--card-dark)] border border-white/10 rounded-2xl p-8 shadow-2xl overflow-hidden">
          <!-- Window dots -->
          <div class="flex justify-between items-center mb-8 border-b border-white/5 pb-4">
            <div class="flex gap-2">
              <div class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></div>
              <div class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
              <div class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></div>
            </div>
            <div class="text-xs font-mono text-gray-500 flex items-center gap-2">
              <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
              AI ANALYZING...
            </div>
          </div>
          <!-- Before -->
          <div class="relative space-y-4 mb-8">
            <div class="absolute -left-4 top-0 bottom-0 w-1 bg-gradient-to-b from-transparent via-red-500/50 to-transparent"></div>
            <h3 class="text-sm text-gray-500 font-mono mb-2 uppercase tracking-wider">Before Analysis</h3>
            <div class="serif-text text-gray-400 space-y-3 text-sm leading-relaxed scrambled-text select-none" lang="ja">
              <p>第4条（敷金返還） 賃貸人は 賃貸借期間が 満了되어 賃借人으로부터 敷金을 受領하는 即時... 本 契約의 特約事項에 依據하여 第█項의 規定은 排除되며...</p>
              <p>賃借人の 過失로 인한 破損 및 毀損에 대해서는 原状復旧의 義務를 가지며, 이는 通常的인 磨耗를 包含하지 아니한다. 但, 天災地変에 의한...</p>
            </div>
            <p class="text-[11px] text-indigo-400/60 italic mt-1">이것이 농인이 보는 계약서입니다. 글자는 보입니다. 의미는 도달하지 않습니다.</p>
            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-indigo-500/10 to-transparent h-[100px] w-full animate-scan pointer-events-none border-b border-indigo-500/30"></div>
          </div>
          <!-- AI preview -->
          <div class="bg-indigo-500/5 rounded-xl border border-indigo-500/20 p-5 relative overflow-hidden transition-all duration-500 hover:bg-indigo-500/10">
            <div class="absolute top-0 right-0 p-3 opacity-20">
              <span class="material-symbols-outlined text-4xl text-indigo-400">smart_toy</span>
            </div>
            <h3 class="text-sm text-indigo-400 font-bold mb-3 flex items-center gap-2">
              <span class="material-symbols-outlined text-lg">check_circle</span>
              핵심 의미 추출
            </h3>
            <div class="space-y-3">
              <div class="flex items-start gap-3">
                <div class="mt-1 min-w-[24px] h-6 rounded bg-indigo-500/20 flex items-center justify-center text-indigo-300 text-xs font-bold">1</div>
                <p class="text-sm text-gray-200"><span class="text-red-400 font-medium">위험:</span> 다음 세입자가 들어와야 돈을 돌려준다는 조건이 있습니다.</p>
              </div>
              <div class="flex items-start gap-3">
                <div class="mt-1 min-w-[24px] h-6 rounded bg-indigo-500/20 flex items-center justify-center text-indigo-300 text-xs font-bold">2</div>
                <p class="text-sm text-gray-200">이사 날짜에 보증금을 바로 받지 못할 확률이 <span class="text-indigo-400 font-medium">92%</span>입니다.</p>
              </div>
            </div>
            <div class="mt-4 pt-3 border-t border-indigo-500/10 flex justify-between items-center">
              <span class="text-xs text-gray-500">생성된 시나리오 3건</span>
              <span class="text-xs text-indigo-300 flex items-center gap-1 cursor-pointer hover:underline">
                자세히 보기 <span class="material-symbols-outlined text-xs">arrow_forward</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- UNIFIED SIDEBAR (fixed, hidden on intro)                      -->
<!-- ============================================================ -->
<aside id="unifiedSidebar" class="fixed left-0 top-0 h-full w-20 flex-col items-center py-6 z-40" style="display:none;">
  <div class="mb-8 cursor-pointer" onclick="showScreen('intro')">
    <span class="material-symbols-outlined text-3xl text-[var(--primary-indigo)]">assignment_turned_in</span>
  </div>
  <nav class="flex-1 space-y-4 w-full flex flex-col items-center">
    <button id="sidebarBtnUpload" onclick="showScreen('upload')" class="sidebar-nav-btn p-3 rounded-xl relative group">
      <span class="material-symbols-outlined">upload_file</span>
      <span class="absolute left-16 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-gray-700 z-50">계약서 업로드</span>
    </button>
    <button id="sidebarBtnArchive" onclick="toggleSidebarPanel('archive')" class="sidebar-nav-btn p-3 rounded-xl relative group">
      <span class="material-symbols-outlined">folder_open</span>
      <span class="absolute left-16 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-gray-700 z-50">보관함</span>
    </button>
    <button id="sidebarBtnSettings" onclick="showScreen('settings')" class="sidebar-nav-btn p-3 rounded-xl relative group">
      <span class="material-symbols-outlined">settings</span>
      <span class="absolute left-16 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-gray-700 z-50">설정</span>
    </button>
  </nav>
  <button onclick="toggleTheme()" class="mb-4 p-2 rounded-lg transition-colors sidebar-nav-btn" title="테마 전환">
    <span id="sidebarThemeIcon" class="material-symbols-outlined text-xl">light_mode</span>
  </button>
  <div class="cursor-pointer sidebar-avatar" onclick="handleSidebarAvatarClick()">
    <div class="w-10 h-10 rounded-full overflow-hidden border border-[var(--border-color)] flex items-center justify-center" style="background:var(--bg-card);color:var(--text-muted);">
      <span class="material-symbols-outlined sidebar-avatar-icon">person</span>
      <img class="sidebar-avatar-img hidden w-full h-full object-cover" src="" alt=""/>
    </div>
  </div>
</aside>

<!-- Slide Panel: Archive -->
<div id="archivePanel" class="slide-panel custom-scroll">
  <div class="p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-bold" style="color:var(--text-primary);">보관함</h3>
      <button onclick="closeSidebarPanel()" class="p-1 rounded-lg" style="color:var(--text-muted);">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div id="archivePanelContent"></div>
  </div>
</div>

<!-- Slide Panel: Settings -->
<div id="settingsPanel" class="slide-panel custom-scroll">
  <div class="p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-bold" style="color:var(--text-primary);">설정</h3>
      <button onclick="closeSidebarPanel()" class="p-1 rounded-lg" style="color:var(--text-muted);">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div id="settingsPanelContent"></div>
  </div>
</div>

<!-- Panel Backdrop -->
<div id="panelBackdrop" class="slide-panel-backdrop" onclick="closeSidebarPanel()"></div>


<!-- ============================================================ -->
<!-- SCREEN 5: SETTINGS (full-page)                                -->
<!-- ============================================================ -->
<div id="settingsScreen" class="screen h-screen overflow-hidden">
  <main class="flex-1 flex flex-col overflow-hidden ml-20 relative" style="background:var(--bg-primary);">
    <!-- BG blurs -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
      <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-indigo-600/10 rounded-full blur-3xl"></div>
      <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-indigo-900/10 rounded-full blur-3xl"></div>
    </div>
    <!-- Top bar -->
    <div class="px-8 py-4 flex items-center gap-3 flex-shrink-0 relative z-10" style="border-bottom:1px solid var(--border-color);background:var(--bg-secondary);">
      <button onclick="goBackFromSettings()" class="p-2 rounded-lg transition-colors" style="color:var(--text-secondary);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">
        <span class="material-symbols-outlined">arrow_back</span>
      </button>
      <h2 class="text-lg font-bold" style="color:var(--text-primary);">설정</h2>
    </div>
    <!-- Scrollable content -->
    <div class="flex-1 overflow-y-auto custom-scroll relative z-10">
      <div class="max-w-4xl mx-auto px-8 py-8 space-y-6" id="settingsScreenContent">
        <!-- Rendered dynamically by renderSettingsScreen() -->
      </div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- SCREEN 2: UPLOAD (dark + sidebar)                             -->
<!-- ============================================================ -->
<div id="uploadScreen" class="screen h-screen overflow-hidden">
  <!-- Main upload area -->
  <main class="flex-1 flex flex-col items-center justify-center p-8 relative overflow-hidden ml-20">
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
      <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-indigo-600/10 rounded-full blur-3xl"></div>
      <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-indigo-900/10 rounded-full blur-3xl"></div>
    </div>
    <div class="max-w-3xl w-full z-10 space-y-10 text-center">
      <div class="space-y-4">
        <h1 class="text-4xl md:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
          계약서 분석 시작하기
        </h1>
        <p class="text-lg text-gray-400 font-light max-w-2xl mx-auto">
          AI가 복잡한 법률 용어를 이해하기 쉬운 수어와 시나리오로 변환해드립니다.
          <br class="hidden md:block"/>
          PDF 또는 이미지 파일을 업로드하세요.
        </p>
      </div>

      <!-- Upload drop zone -->
      <div class="group relative w-full" id="dropZone">
        <input class="hidden" id="fileInput" type="file" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.bmp,.tif,.tiff,.heic,.heif,.html,.htm,.txt,.csv,.rtf" onchange="handleFileSelect(event)"/>
        <label class="block w-full cursor-pointer" for="fileInput">
          <div class="glass-panel rounded-3xl p-16 flex flex-col items-center justify-center transition-all duration-300 group-hover:border-indigo-500/50 group-hover:bg-white/[0.04]" id="dropArea">
            <div class="w-24 h-24 mb-8 rounded-full bg-[#1a1a24] flex items-center justify-center group-hover:scale-105 transition-transform duration-300 border border-[#2a2a3a]">
              <span class="material-symbols-outlined text-4xl text-indigo-400">cloud_upload</span>
            </div>
            <h3 class="text-xl font-medium text-white mb-2">계약서 파일을 이곳에 드래그하세요</h3>
            <p class="text-sm text-gray-500 mb-8">또는 클릭하여 파일 선택 (PDF, 이미지, HTML, TXT 등)</p>
            <span class="px-8 py-3 rounded-xl border border-indigo-500/30 text-indigo-300 font-medium hover:bg-indigo-500/10 hover:border-indigo-500/60 transition-all duration-200 flex items-center gap-2">
              <span class="material-symbols-outlined text-sm">folder_open</span>
              파일 선택하기
            </span>
          </div>
        </label>
        <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-3xl opacity-0 group-hover:opacity-20 blur transition duration-500 pointer-events-none"></div>
      </div>

      <!-- Security note + sample link -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-6 text-sm text-gray-500">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-base">security</span>
          <span>모든 문서는 암호화되어 안전하게 처리됩니다</span>
        </div>
        <div class="hidden md:block w-1 h-1 bg-gray-700 rounded-full"></div>
        <a class="flex items-center gap-1 text-indigo-400 hover:text-indigo-300 transition-colors group cursor-pointer" onclick="loadDemo()">
          <span>샘플 계약서로 미리보기</span>
          <span class="material-symbols-outlined text-base group-hover:translate-x-0.5 transition-transform">arrow_forward</span>
        </a>
      </div>
    </div>

    <!-- Dynamic history section -->
    <div id="historySection" class="mt-16 w-full max-w-3xl glass-panel rounded-2xl p-6 opacity-60 hover:opacity-100 transition-opacity" style="display:none;">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-sm font-semibold text-gray-300 flex items-center gap-2">
          <span class="material-symbols-outlined text-base">history</span>
          최근 분석 기록
        </h4>
      </div>
      <div id="historyList" class="space-y-3"></div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- SCREEN 3: LOADING (light + sidebar)                           -->
<!-- ============================================================ -->
<div id="loadingScreen" class="screen h-screen overflow-hidden">
  <!-- Loading content -->
  <main class="flex-1 flex flex-col items-center justify-center relative bg-gray-50 overflow-hidden ml-20">
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
      <div class="absolute top-[20%] left-[10%] w-64 h-64 bg-indigo-200 rounded-full blur-[100px] opacity-30"></div>
      <div class="absolute bottom-[20%] right-[10%] w-80 h-80 bg-blue-100 rounded-full blur-[120px] opacity-40"></div>
    </div>
    <div class="relative z-10 flex flex-col items-center">
      <!-- Document preview -->
      <div class="relative w-72 bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden mb-12">
        <div class="h-4 bg-indigo-50 border-b border-indigo-100 flex items-center px-3 gap-1.5">
          <div class="w-1.5 h-1.5 rounded-full bg-indigo-200"></div>
          <div class="w-1.5 h-1.5 rounded-full bg-indigo-200"></div>
        </div>
        <div class="p-6 space-y-4">
          <div class="h-6 bg-gray-100 rounded w-3/4"></div>
          <div class="space-y-2">
            <div class="h-3 bg-gray-50 rounded w-full"></div>
            <div class="h-3 bg-gray-50 rounded w-5/6"></div>
            <div class="h-3 bg-gray-50 rounded w-full"></div>
            <div class="h-3 bg-gray-50 rounded w-4/6"></div>
          </div>
          <div class="h-20 bg-indigo-50/50 rounded-lg border border-indigo-50 p-3 space-y-2">
            <div class="h-2 bg-indigo-100 rounded w-1/3"></div>
            <div class="h-2 bg-indigo-100/50 rounded w-full"></div>
            <div class="h-2 bg-indigo-100/50 rounded w-5/6"></div>
          </div>
        </div>
        <!-- Scan line -->
        <div class="absolute left-0 right-0 h-1 scan-line z-20"></div>
        <div class="absolute inset-0 bg-gradient-to-b from-white/10 to-indigo-50/10 pointer-events-none"></div>
      </div>

      <!-- Pulse icon -->
      <div class="relative flex items-center justify-center mb-8">
        <div class="absolute w-16 h-16 rounded-full border-2 border-indigo-100 animate-pulse-ring"></div>
        <div class="absolute w-16 h-16 rounded-full border-2 border-indigo-50 animate-pulse-ring" style="animation-delay:0.5s"></div>
        <div class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-[var(--primary-indigo)] relative z-10 border border-indigo-50">
          <span class="material-symbols-outlined text-2xl animate-spin">smart_toy</span>
        </div>
      </div>

      <h2 class="text-xl font-bold text-gray-900 mb-3 tracking-tight">조항을 분석하고 있습니다...</h2>
      <p class="text-gray-500 text-sm font-medium flex items-center gap-2">
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce-dot"></span>
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce-dot" style="animation-delay:0.16s"></span>
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-bounce-dot" style="animation-delay:0.32s"></span>
        <span id="loadingStatusText">AI가 위험 요소를 감지하는 중</span>
      </p>
      <!-- Progress bar -->
      <div class="w-64 h-1.5 bg-gray-200 rounded-full mt-8 overflow-hidden">
        <div id="progressBar" class="h-full bg-[var(--primary-indigo)] rounded-full shadow-[0_0_10px_rgba(79,70,229,0.4)] progress-shimmer transition-all duration-500" style="width:0%"></div>
      </div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- SCREEN 4: RESULT (light + sidebar)                            -->
<!-- ============================================================ -->
<div id="resultScreen" class="screen h-screen overflow-hidden">
  <!-- Result content: 2-column -->
  <main class="flex-1 flex flex-col bg-gray-50 overflow-hidden ml-20">
    <!-- Top bar -->
    <div class="px-8 py-4 bg-white border-b border-gray-200 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-3">
        <span class="material-symbols-outlined text-gray-400">description</span>
        <span id="resultDemoTag" class="px-2 py-0.5 rounded text-[10px] font-bold bg-indigo-100 text-indigo-600 hidden">데모</span>
        <span id="resultFileName" class="text-sm font-medium text-gray-700">2024년 2월 주택임대차계약서.pdf</span>
        <span id="resultRiskBadge" class="px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600">위험</span>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="showScreen('upload')" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-1.5">
          <span class="material-symbols-outlined text-base">upload_file</span>
          새 계약서 분석
        </button>
      </div>
    </div>

    <!-- 2-column body -->
    <div class="flex-1 flex overflow-hidden">
      <!-- LEFT: Contract document viewer -->
      <div class="flex-1 overflow-y-auto custom-scroll p-8" id="contractViewer">
        <div class="max-w-2xl mx-auto pr-10">
          <!-- Demo mode banner (hidden by default) -->
          <div id="demoBanner" class="demo-banner rounded-xl p-4 mb-6 hidden">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-indigo-500 text-xl">science</span>
              <div>
                <p class="text-sm font-bold text-indigo-700">데모 모드</p>
                <p class="text-xs text-indigo-500">샘플 위험 계약서로 분석 결과를 미리 확인합니다</p>
              </div>
            </div>
          </div>
          <!-- Fallback mode banner (hidden by default) -->
          <div id="fallbackBanner" class="rounded-xl p-4 mb-6 hidden" style="background:linear-gradient(135deg,#FEF3C7,#FDE68A);border:1px dashed #F59E0B;">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-amber-600 text-xl">info</span>
              <div>
                <p class="text-sm font-bold text-amber-800">데모 데이터로 표시 중</p>
                <p class="text-xs text-amber-600">AI 분석에 실패하여 사전 준비된 샘플 결과를 보여드립니다. 실제 계약서 분석 결과가 아닙니다.</p>
              </div>
            </div>
          </div>

          <!-- File preview (collapsible, only for real uploads) -->
          <div id="filePreviewSection" class="mb-6 hidden">
            <button onclick="toggleFilePreview()" class="flex items-center gap-2 text-sm text-gray-500 hover:text-gray-700 mb-2 transition-colors">
              <span class="material-symbols-outlined text-base" id="filePreviewToggleIcon">expand_more</span>
              <span>원본 파일 미리보기</span>
            </button>
            <div id="filePreviewContainer" class="file-preview-container max-h-[200px] rounded-xl border border-gray-200 overflow-hidden bg-white">
              <div id="filePreviewContent" class="w-full h-[200px] flex items-center justify-center"></div>
            </div>
          </div>

          <h2 class="text-xl font-bold text-gray-900 mb-1">부동산임대차계약서</h2>
          <p class="text-sm text-gray-400 mb-6">국토교통부 표준 계약서 기준 분석 결과</p>
          <!-- Summary cards -->
          <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-xl border border-gray-200 p-4 text-center">
              <p class="text-xs text-gray-400 mb-1">위험 조항</p>
              <p id="summaryRiskCount" class="text-2xl font-bold text-red-500">-</p>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 text-center">
              <p class="text-xs text-gray-400 mb-1">전체 조항</p>
              <p id="summaryTotalCount" class="text-2xl font-bold text-gray-900">-</p>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 text-center">
              <p class="text-xs text-gray-400 mb-1">최대 위험 금액</p>
              <p id="summaryMaxRisk" class="text-2xl font-bold text-red-500">-</p>
            </div>
          </div>
          <!-- Clauses rendered here (Grammarly annotation view) -->
          <div id="clauseList" class="space-y-1"></div>

          <!-- Comprehension quiz section -->
          <div id="comprehensionSection" class="mt-10 hidden">
            <div class="border-t border-gray-200 pt-8">
              <h3 class="text-lg font-bold text-gray-900 mb-1 flex items-center gap-2">
                <span class="material-symbols-outlined text-green-500">quiz</span>
                이해도 확인
              </h3>
              <p class="text-sm text-gray-400 mb-6">계약서 내용을 제대로 이해했는지 확인해보세요</p>
              <div id="comprehensionContent" class="space-y-6"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Analysis panel -->
      <div id="sidePanel" class="w-[420px] bg-white border-l border-gray-200 flex flex-col overflow-hidden flex-shrink-0">
        <!-- Default: checklist view -->
        <div id="panelDefault" class="flex-1 overflow-y-auto custom-scroll p-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-indigo-500">checklist</span>
            핵심 확인 리스트
          </h3>
          <div id="checklistItems" class="space-y-3"></div>

          <!-- Charts -->
          <div class="mt-8 space-y-6">
            <div>
              <h4 class="text-sm font-semibold text-gray-700 mb-3">조항별 위험도</h4>
              <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                <canvas id="deviationChart" height="200"></canvas>
              </div>
            </div>
            <div>
              <h4 class="text-sm font-semibold text-gray-700 mb-3">위험 등급 분포</h4>
              <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                <canvas id="riskChart" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- Overall action -->
          <div id="overallActionBox" class="mt-6 bg-red-50 border border-red-200 rounded-xl p-4 hidden">
            <h4 class="text-sm font-bold text-red-700 mb-2 flex items-center gap-1.5">
              <span class="material-symbols-outlined text-base">warning</span>
              전체 경고
            </h4>
            <p id="overallActionText" class="text-sm text-red-600 whitespace-pre-line"></p>
          </div>
        </div>

        <!-- Detail: shown when a clause is clicked -->
        <div id="panelDetail" class="flex-1 overflow-y-auto custom-scroll p-6 hidden">
          <button onclick="closePanelDetail()" class="mb-4 text-sm text-gray-400 hover:text-gray-600 flex items-center gap-1 transition-colors">
            <span class="material-symbols-outlined text-base">arrow_back</span>
            리스트로 돌아가기
          </button>
          <div class="flex items-center gap-2 mb-4">
            <span id="detailNumber" class="text-lg font-bold text-gray-900"></span>
            <span id="detailTitle" class="text-lg font-bold text-gray-900"></span>
            <span id="detailBadge" class="px-2 py-0.5 rounded text-xs font-bold"></span>
          </div>

          <!-- Deviation bar -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-1.5">
              <span class="text-xs text-gray-500">표준 이탈도</span>
              <span id="detailScore" class="text-xs font-bold"></span>
            </div>
            <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
              <div id="detailScoreBar" class="h-full rounded-full transition-all duration-500"></div>
            </div>
            <p id="detailDirection" class="text-xs text-gray-400 mt-1.5"></p>
          </div>

          <!-- Easy Korean tabs -->
          <div class="mb-6">
            <div class="flex gap-4 border-b border-gray-100 mb-4">
              <button class="tab-btn active-tab text-sm font-medium text-indigo-600" onclick="switchTab(1)">쉬운 설명</button>
              <button class="tab-btn text-sm font-medium text-gray-400 hover:text-gray-600" onclick="switchTab(2)">비유 설명</button>
              <button class="tab-btn text-sm font-medium text-gray-400 hover:text-gray-600" onclick="switchTab(3)">시나리오</button>
            </div>
            <div id="easyKoreanContent" class="text-sm text-gray-700 leading-relaxed bg-indigo-50/50 rounded-xl p-4 border border-indigo-100"></div>
          </div>

          <!-- Original vs Standard -->
          <div class="mb-6 space-y-3">
            <div>
              <h4 class="text-xs font-semibold text-red-500 mb-1.5 flex items-center gap-1">
                <span class="material-symbols-outlined text-xs">error</span>
                이 계약서 원문
              </h4>
              <p id="detailOriginal" class="text-sm text-gray-600 bg-red-50 rounded-lg p-3 border border-red-100 leading-relaxed"></p>
            </div>
            <div>
              <h4 class="text-xs font-semibold text-green-600 mb-1.5 flex items-center gap-1">
                <span class="material-symbols-outlined text-xs">verified</span>
                표준 계약서 원문
              </h4>
              <p id="detailStandard" class="text-sm text-gray-600 bg-green-50 rounded-lg p-3 border border-green-100 leading-relaxed"></p>
            </div>
          </div>

          <!-- Action script -->
          <div id="detailActionBox" class="bg-amber-50 border border-amber-200 rounded-xl p-4">
            <h4 class="text-sm font-bold text-amber-700 mb-2 flex items-center gap-1.5">
              <span class="material-symbols-outlined text-base">record_voice_over</span>
              행동 스크립트
            </h4>
            <p id="detailActionMessage" class="text-sm text-amber-800 whitespace-pre-line leading-relaxed"></p>
            <button onclick="copyAction()" class="mt-3 px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-lg text-xs font-medium transition-colors flex items-center gap-1.5">
              <span class="material-symbols-outlined text-sm">content_copy</span>
              수정 요청 문구 복사
            </button>
          </div>

          <!-- Structured Breakdown -->
          <div id="detailBreakdown" class="mt-6 hidden">
            <h4 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-1.5">
              <span class="material-symbols-outlined text-base text-indigo-500">list_alt</span>
              한눈에 보기
            </h4>
            <div id="detailBreakdownContent" class="bg-indigo-50/50 border border-indigo-100 rounded-xl p-4 space-y-2"></div>
          </div>

          <!-- Term Glossary -->
          <div id="detailGlossary" class="mt-6 hidden">
            <h4 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-1.5">
              <span class="material-symbols-outlined text-base text-purple-500">menu_book</span>
              어려운 말 쉽게 풀기
            </h4>
            <div id="detailGlossaryContent" class="space-y-3"></div>
          </div>
        </div>

        <!-- Bottom CTA -->
        <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
          <button class="w-full py-3 bg-[var(--primary-indigo)] hover:bg-[var(--primary-indigo-hover)] text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-lg">summarize</span>
            전체 리포트 보러가기
          </button>
        </div>
      </div>
    </div>
  </main>
</div>


<!-- ============================================================ -->
<!-- GLOBAL LOGIN MODAL                                             -->
<!-- ============================================================ -->
<div id="loginModal" class="login-modal-overlay" onclick="if(event.target===this)closeLoginModal()">
  <div class="login-modal-box text-center">
    <div class="w-14 h-14 mx-auto mb-4 bg-[var(--primary-indigo)] rounded-2xl flex items-center justify-center">
      <span class="material-symbols-outlined text-3xl text-white">assignment_turned_in</span>
    </div>
    <h3 class="text-xl font-bold mb-2" style="color:var(--text-primary);">ClearSign 로그인</h3>
    <p class="text-sm mb-6" style="color:var(--text-secondary);">Google 계정으로 로그인하여<br/>분석 기록을 저장하세요</p>
    <div id="googleBtnContainerModal" class="flex justify-center mb-4"></div>
    <p id="loginUnavailableMsgModal" class="hidden text-xs text-red-400 mb-4">Google 로그인을 사용할 수 없습니다.</p>
    <button onclick="closeLoginModal()" class="text-sm hover:underline" style="color:var(--text-muted);">나중에 하기</button>
  </div>
</div>

<!-- ============================================================ -->
<!-- JAVASCRIPT                                                     -->
<!-- ============================================================ -->
<script>
// ---- State ----
let analysisData = null;
let currentClauseIdx = -1;
let currentTabLevel = 1;
let deviationChartInstance = null;
let riskChartInstance = null;
let uploadedFileUrl = null;
let uploadedFileType = null;
let isDemoMode = false;
let currentUser = null;
let filePreviewOpen = true;
let loadingStartTime = 0;
let currentTheme = localStorage.getItem('cs_theme') || 'dark';
let currentPanel = null;
let previousScreenName = null;
let settingsAutoAnalysis = localStorage.getItem('cs_auto_analysis') !== 'false';
let settingsEasyLevel = parseInt(localStorage.getItem('cs_easy_level') || '2');
let settingsHighContrast = localStorage.getItem('cs_high_contrast') === 'true';

// ---- Theme ----
function applyTheme() {
  document.body.setAttribute('data-theme', currentTheme);
  localStorage.setItem('cs_theme', currentTheme);
  const icon = document.getElementById('sidebarThemeIcon');
  if (icon) icon.textContent = currentTheme === 'dark' ? 'light_mode' : 'dark_mode';
}

function toggleTheme() {
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  applyTheme();
  if (currentPanel === 'settings') renderSettingsPanel();
  if (document.getElementById('settingsScreen')?.classList.contains('active')) renderSettingsScreen();
}

function setTheme(theme) {
  currentTheme = theme;
  applyTheme();
  if (currentPanel === 'settings') renderSettingsPanel();
  if (document.getElementById('settingsScreen')?.classList.contains('active')) renderSettingsScreen();
}

// ---- Google OAuth ----
let googleLoginReady = false;

function onLoginClick() {
  const dropdown = document.getElementById('googleLoginDropdown');
  const msg = document.getElementById('loginUnavailableMsg');
  dropdown.classList.toggle('hidden');
  if (!googleLoginReady && msg) msg.classList.remove('hidden');
}

async function initGoogleLogin() {
  try {
    const res = await fetch('/api/config');
    const cfg = await res.json();
    if (!cfg.googleClientId) return;
    google.accounts.id.initialize({
      client_id: cfg.googleClientId,
      callback: handleGoogleLogin,
    });
    google.accounts.id.renderButton(
      document.getElementById('googleBtnContainer'),
      { theme: 'filled_black', size: 'large', shape: 'pill', text: 'signin_with', width: 208 }
    );
    const modalContainer = document.getElementById('googleBtnContainerModal');
    if (modalContainer) {
      google.accounts.id.renderButton(
        modalContainer,
        { theme: 'filled_black', size: 'large', shape: 'pill', text: 'signin_with', width: 280 }
      );
    }
    googleLoginReady = true;
  } catch (e) { console.log('Google login unavailable'); }
}

function handleGoogleLogin(response) {
  try {
    const token = response.credential;
    const payload = JSON.parse(atob(token.split('.')[1]));
    currentUser = { name: payload.name, picture: payload.picture, email: payload.email };
    localStorage.setItem('gsi_token', token);
    const dropdown = document.getElementById('googleLoginDropdown');
    if (dropdown) dropdown.classList.add('hidden');
    closeLoginModal();
    updateUserUI();
    renderHistorySection();
  } catch (e) {
    console.error('Google login error:', e);
  }
}

function checkSavedLogin() {
  const token = localStorage.getItem('gsi_token');
  if (!token) return;
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    if (payload.exp * 1000 < Date.now()) {
      localStorage.removeItem('gsi_token');
      return;
    }
    currentUser = { name: payload.name, picture: payload.picture, email: payload.email };
    updateUserUI();
  } catch { localStorage.removeItem('gsi_token'); }
}

function updateUserUI() {
  if (!currentUser) return;
  const loginBtn = document.getElementById('loginBtnIntro');
  const profile = document.getElementById('userProfileIntro');
  if (loginBtn) loginBtn.classList.add('hidden');
  const dropdown = document.getElementById('googleLoginDropdown');
  if (dropdown) dropdown.classList.add('hidden');
  if (profile) {
    profile.classList.remove('hidden');
    document.getElementById('userAvatarIntro').src = currentUser.picture || '';
    document.getElementById('userNameIntro').textContent = currentUser.name || '';
  }
  document.querySelectorAll('.sidebar-avatar').forEach(el => {
    const icon = el.querySelector('.sidebar-avatar-icon');
    const img = el.querySelector('.sidebar-avatar-img');
    if (icon && img && currentUser.picture) {
      icon.classList.add('hidden');
      img.src = currentUser.picture;
      img.classList.remove('hidden');
    }
  });
}

function toggleUserMenu() {
  handleLogout();
}

function handleLogout() {
  if (confirm('로그아웃하시겠습니까?')) {
    localStorage.removeItem('gsi_token');
    currentUser = null;
    location.reload();
  }
}

// ---- Login Modal ----
function openLoginModal() {
  const modal = document.getElementById('loginModal');
  if (modal) modal.classList.add('open');
  if (!googleLoginReady) {
    const msg = document.getElementById('loginUnavailableMsgModal');
    if (msg) msg.classList.remove('hidden');
  }
}

function closeLoginModal() {
  const modal = document.getElementById('loginModal');
  if (modal) modal.classList.remove('open');
}

function handleSidebarAvatarClick() {
  if (currentUser) {
    showScreen('settings');
  } else {
    openLoginModal();
  }
}

// ---- Sidebar Panels ----
function toggleSidebarPanel(panelName) {
  if (currentPanel === panelName) {
    closeSidebarPanel();
    return;
  }
  closeSidebarPanel();
  currentPanel = panelName;
  const panel = document.getElementById(panelName + 'Panel');
  const backdrop = document.getElementById('panelBackdrop');
  if (panelName === 'archive') renderArchivePanel();
  if (panelName === 'settings') renderSettingsPanel();
  if (panel) panel.classList.add('open');
  if (backdrop) backdrop.classList.add('open');
}

function closeSidebarPanel() {
  currentPanel = null;
  document.querySelectorAll('.slide-panel').forEach(p => p.classList.remove('open'));
  const backdrop = document.getElementById('panelBackdrop');
  if (backdrop) backdrop.classList.remove('open');
}

function renderArchivePanel() {
  const container = document.getElementById('archivePanelContent');
  if (!container) return;
  if (!currentUser) {
    container.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-center">' +
      '<span class="material-symbols-outlined text-4xl mb-3" style="color:var(--text-muted)">lock</span>' +
      '<p class="text-sm" style="color:var(--text-secondary)">로그인 후 확인 가능합니다</p>' +
      '<button onclick="closeSidebarPanel();openLoginModal()" class="mt-4 px-4 py-2 bg-[var(--primary-indigo)] text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">로그인</button></div>';
    return;
  }
  const history = JSON.parse(localStorage.getItem('cs_analysis_history') || '[]');
  if (history.length === 0) {
    container.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-center">' +
      '<span class="material-symbols-outlined text-4xl mb-3" style="color:var(--text-muted)">folder_off</span>' +
      '<p class="text-sm" style="color:var(--text-secondary)">분석 기록이 없습니다</p>' +
      '<p class="text-xs mt-1" style="color:var(--text-muted)">계약서를 분석하면 여기에 저장됩니다</p></div>';
    return;
  }
  container.innerHTML = history.map((item, idx) =>
    '<div onclick="loadHistoryEntry(' + idx + ');closeSidebarPanel()" class="p-3 rounded-lg cursor-pointer transition-colors mb-2" style="border:1px solid var(--border-color);" onmouseover="this.style.background=\'var(--hover-bg)\'" onmouseout="this.style.background=\'transparent\'">' +
      '<div class="flex items-center justify-between">' +
        '<div class="flex-1 min-w-0"><p class="text-sm font-medium truncate" style="color:var(--text-primary)">' + item.filename + '</p>' +
        '<p class="text-xs mt-0.5" style="color:var(--text-muted)">' + item.date + '</p></div>' +
        '<span class="px-2 py-0.5 rounded text-[10px] font-bold ml-2 ' +
          (item.riskLevel === 'high' ? 'bg-red-500/10 text-red-400' : item.riskLevel === 'medium' ? 'bg-amber-500/10 text-amber-400' : 'bg-green-500/10 text-green-400') +
        '">' + item.riskGrade + '</span>' +
      '</div></div>'
  ).join('');
}

function renderSettingsPanel() {
  const container = document.getElementById('settingsPanelContent');
  if (!container) return;
  container.innerHTML =
    '<div class="space-y-6">' +
      '<div><h4 class="text-sm font-semibold mb-3" style="color:var(--text-primary)">테마</h4>' +
        '<div class="flex gap-2">' +
          '<button onclick="setTheme(\'light\')" class="flex-1 py-2.5 rounded-lg text-sm font-medium border transition-colors ' + (currentTheme === 'light' ? 'bg-[var(--primary-indigo)] text-white border-[var(--primary-indigo)]' : '') + '" style="' + (currentTheme !== 'light' ? 'color:var(--text-secondary);border-color:var(--border-color)' : '') + '">' +
            '<span class="material-symbols-outlined text-base align-middle mr-1">light_mode</span>라이트</button>' +
          '<button onclick="setTheme(\'dark\')" class="flex-1 py-2.5 rounded-lg text-sm font-medium border transition-colors ' + (currentTheme === 'dark' ? 'bg-[var(--primary-indigo)] text-white border-[var(--primary-indigo)]' : '') + '" style="' + (currentTheme !== 'dark' ? 'color:var(--text-secondary);border-color:var(--border-color)' : '') + '">' +
            '<span class="material-symbols-outlined text-base align-middle mr-1">dark_mode</span>다크</button>' +
        '</div></div>' +
      '<div><h4 class="text-sm font-semibold mb-3" style="color:var(--text-primary)">계정</h4>' +
        (currentUser ?
          '<div class="flex items-center gap-3 p-3 rounded-lg" style="border:1px solid var(--border-color)">' +
            '<img src="' + currentUser.picture + '" class="w-10 h-10 rounded-full" alt=""/>' +
            '<div class="flex-1 min-w-0"><p class="text-sm font-medium truncate" style="color:var(--text-primary)">' + currentUser.name + '</p>' +
            '<p class="text-xs truncate" style="color:var(--text-muted)">' + currentUser.email + '</p></div></div>' +
            '<button onclick="handleLogout()" class="mt-3 w-full py-2 text-sm text-red-400 hover:text-red-300 rounded-lg hover:bg-red-500/5 transition-colors" style="border:1px solid rgba(239,68,68,0.2)">로그아웃</button>'
        :
          '<button onclick="closeSidebarPanel();openLoginModal()" class="w-full py-2.5 bg-[var(--primary-indigo)] text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">Google로 로그인</button>'
        ) +
      '</div>' +
      '<div><h4 class="text-sm font-semibold mb-3" style="color:var(--text-primary)">데이터</h4>' +
        '<button onclick="clearHistory()" class="w-full py-2 text-sm rounded-lg transition-colors" style="color:var(--text-secondary);border:1px solid var(--border-color)" onmouseover="this.style.background=\'var(--hover-bg)\'" onmouseout="this.style.background=\'transparent\'">분석 기록 초기화</button></div>' +
      '<div class="pt-4" style="border-top:1px solid var(--border-color)"><p class="text-xs" style="color:var(--text-muted)">ClearSign v1.0.0</p>' +
        '<p class="text-xs mt-0.5" style="color:var(--text-muted)">Gemini 3 Seoul Hackathon</p></div>' +
    '</div>';
}

// ---- Full-Page Settings Screen ----
function renderSettingsScreen() {
  const container = document.getElementById('settingsScreenContent');
  if (!container) return;

  const levelLabels = { 1: '간단', 2: '보통', 3: '상세' };
  const levelColors = { 1: 'bg-green-100 text-green-700', 2: 'bg-indigo-100 text-indigo-700', 3: 'bg-purple-100 text-purple-700' };

  container.innerHTML =
    // ---- Profile Card ----
    '<div id="settingsProfile" class="rounded-[16px] p-8 border" style="background:var(--bg-card);border-color:var(--border-color);">' +
      (currentUser ?
        '<div class="flex items-center gap-5">' +
          '<img src="' + (currentUser.picture || '') + '" class="w-16 h-16 rounded-full border-2" style="border-color:var(--border-color);" alt="프로필"/>' +
          '<div class="flex-1 min-w-0">' +
            '<h3 class="text-xl font-bold truncate" style="color:var(--text-primary);">' + (currentUser.name || '') + '</h3>' +
            '<p class="text-sm truncate" style="color:var(--text-secondary);">' + (currentUser.email || '') + '</p>' +
          '</div>' +
          '<button onclick="handleLogout()" class="px-5 py-2.5 rounded-xl text-sm font-medium border transition-colors" style="color:var(--text-secondary);border-color:var(--border-color);" onmouseover="this.style.background=\'var(--hover-bg)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<span class="material-symbols-outlined text-base align-middle mr-1">logout</span>로그아웃' +
          '</button>' +
        '</div>'
      :
        '<div class="flex items-center gap-5">' +
          '<div class="w-16 h-16 rounded-full flex items-center justify-center" style="background:var(--hover-bg);border:1px solid var(--border-color);">' +
            '<span class="material-symbols-outlined text-3xl" style="color:var(--text-muted);">person</span>' +
          '</div>' +
          '<div class="flex-1">' +
            '<h3 class="text-lg font-bold" style="color:var(--text-primary);">로그인이 필요합니다</h3>' +
            '<p class="text-sm" style="color:var(--text-secondary);">Google 계정으로 로그인하여 분석 기록을 저장하세요</p>' +
          '</div>' +
          '<button onclick="openLoginModal()" class="px-5 py-2.5 bg-[var(--primary-indigo)] hover:bg-[var(--primary-indigo-hover)] text-white rounded-xl text-sm font-medium transition-colors">' +
            'Google로 로그인' +
          '</button>' +
        '</div>'
      ) +
    '</div>' +

    // ---- Theme Card ----
    '<div class="rounded-[16px] p-8 border" style="background:var(--bg-card);border-color:var(--border-color);">' +
      '<h3 class="text-base font-bold mb-5 flex items-center gap-2" style="color:var(--text-primary);">' +
        '<span class="material-symbols-outlined text-xl" style="color:var(--primary-indigo);">palette</span>테마' +
      '</h3>' +
      '<div class="flex gap-3">' +
        '<button onclick="setTheme(\'light\')" class="flex-1 py-3 rounded-xl text-sm font-medium border transition-all ' +
          (currentTheme === 'light' ? 'bg-[var(--primary-indigo)] text-white border-[var(--primary-indigo)] shadow-lg shadow-indigo-500/20' : '') + '" style="' +
          (currentTheme !== 'light' ? 'color:var(--text-secondary);border-color:var(--border-color)' : '') + '">' +
          '<span class="material-symbols-outlined text-base align-middle mr-1.5">light_mode</span>라이트</button>' +
        '<button onclick="setTheme(\'dark\')" class="flex-1 py-3 rounded-xl text-sm font-medium border transition-all ' +
          (currentTheme === 'dark' ? 'bg-[var(--primary-indigo)] text-white border-[var(--primary-indigo)] shadow-lg shadow-indigo-500/20' : '') + '" style="' +
          (currentTheme !== 'dark' ? 'color:var(--text-secondary);border-color:var(--border-color)' : '') + '">' +
          '<span class="material-symbols-outlined text-base align-middle mr-1.5">dark_mode</span>다크</button>' +
      '</div>' +
    '</div>' +

    // ---- Analysis Settings Card ----
    '<div id="settingsAnalysis" class="rounded-[16px] p-8 border" style="background:var(--bg-card);border-color:var(--border-color);">' +
      '<h3 class="text-base font-bold mb-5 flex items-center gap-2" style="color:var(--text-primary);">' +
        '<span class="material-symbols-outlined text-xl" style="color:var(--primary-indigo);">tune</span>분석 설정' +
      '</h3>' +
      '<div class="space-y-6">' +
        // Auto analysis toggle
        '<div class="flex items-center justify-between">' +
          '<div>' +
            '<p class="text-sm font-medium" style="color:var(--text-primary);">자동 분석 시작</p>' +
            '<p class="text-xs mt-0.5" style="color:var(--text-muted);">파일 업로드 시 즉시 분석을 시작합니다</p>' +
          '</div>' +
          '<div class="settings-toggle' + (settingsAutoAnalysis ? ' active' : '') + '" onclick="toggleAutoAnalysis(this)"></div>' +
        '</div>' +
        // Easy level slider
        '<div>' +
          '<div class="flex items-center justify-between mb-3">' +
            '<div>' +
              '<p class="text-sm font-medium" style="color:var(--text-primary);">쉬운 설명 수준</p>' +
              '<p class="text-xs mt-0.5" style="color:var(--text-muted);">분석 결과의 기본 설명 난이도를 설정합니다</p>' +
            '</div>' +
            '<span id="settingsLevelBadge" class="px-2.5 py-1 rounded-full text-xs font-bold ' + (levelColors[settingsEasyLevel] || levelColors[2]) + '">LEVEL ' + settingsEasyLevel + ' · ' + (levelLabels[settingsEasyLevel] || '보통') + '</span>' +
          '</div>' +
          '<input type="range" min="1" max="3" step="1" value="' + settingsEasyLevel + '" class="settings-range" oninput="updateEasyLevel(parseInt(this.value))">' +
          '<div class="flex justify-between mt-1.5 text-xs" style="color:var(--text-muted);">' +
            '<span>간단</span><span>보통</span><span>상세</span>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>' +

    // ---- Accessibility Card ----
    '<div id="settingsAccessibility" class="rounded-[16px] p-8 border" style="background:var(--bg-card);border-color:var(--border-color);">' +
      '<h3 class="text-base font-bold mb-5 flex items-center gap-2" style="color:var(--text-primary);">' +
        '<span class="material-symbols-outlined text-xl" style="color:var(--primary-indigo);">accessibility_new</span>접근성' +
      '</h3>' +
      '<div class="flex items-center justify-between">' +
        '<div>' +
          '<p class="text-sm font-medium" style="color:var(--text-primary);">고대비 모드</p>' +
          '<p class="text-xs mt-0.5" style="color:var(--text-muted);">텍스트와 배경의 대비를 강화하여 가독성을 높입니다</p>' +
        '</div>' +
        '<div class="settings-toggle' + (settingsHighContrast ? ' active' : '') + '" onclick="toggleHighContrast(this)"></div>' +
      '</div>' +
    '</div>' +

    // ---- Data Management Card ----
    '<div id="settingsData" class="rounded-[16px] p-8 border" style="background:var(--bg-card);border-color:var(--border-color);">' +
      '<h3 class="text-base font-bold mb-5 flex items-center gap-2" style="color:var(--text-primary);">' +
        '<span class="material-symbols-outlined text-xl" style="color:var(--primary-indigo);">database</span>데이터 관리' +
      '</h3>' +
      '<div class="space-y-3">' +
        '<button onclick="clearHistory()" class="w-full py-3 rounded-xl text-sm font-medium border border-red-200 text-red-500 hover:bg-red-50 transition-colors flex items-center justify-center gap-2">' +
          '<span class="material-symbols-outlined text-base">delete_sweep</span>모든 분석 기록 삭제' +
        '</button>' +
        '<button onclick="confirmAccountDeletion()" class="w-full py-3 rounded-xl text-sm font-medium border transition-colors flex items-center justify-center gap-2" style="color:var(--text-muted);border-color:var(--border-color);" onmouseover="this.style.background=\'var(--hover-bg)\'" onmouseout="this.style.background=\'transparent\'">' +
          '<span class="material-symbols-outlined text-base">person_remove</span>계정 탈퇴' +
        '</button>' +
      '</div>' +
    '</div>' +

    // ---- Footer ----
    '<div class="text-center py-4">' +
      '<p class="text-xs" style="color:var(--text-muted);">ClearSign v2.1.0 · <a href="#" class="hover:underline">이용약관</a> · <a href="#" class="hover:underline">개인정보처리방침</a></p>' +
    '</div>';
}

function goBackFromSettings() {
  showScreen(previousScreenName || 'upload');
}

function toggleAutoAnalysis(el) {
  settingsAutoAnalysis = !settingsAutoAnalysis;
  localStorage.setItem('cs_auto_analysis', settingsAutoAnalysis ? 'true' : 'false');
  el.classList.toggle('active', settingsAutoAnalysis);
}

function updateEasyLevel(val) {
  settingsEasyLevel = val;
  localStorage.setItem('cs_easy_level', val.toString());
  currentTabLevel = val;
  const levelLabels = { 1: '간단', 2: '보통', 3: '상세' };
  const levelColors = { 1: 'bg-green-100 text-green-700', 2: 'bg-indigo-100 text-indigo-700', 3: 'bg-purple-100 text-purple-700' };
  const badge = document.getElementById('settingsLevelBadge');
  if (badge) {
    badge.className = 'px-2.5 py-1 rounded-full text-xs font-bold ' + (levelColors[val] || levelColors[2]);
    badge.textContent = 'LEVEL ' + val + ' · ' + (levelLabels[val] || '보통');
  }
}

function toggleHighContrast(el) {
  settingsHighContrast = !settingsHighContrast;
  localStorage.setItem('cs_high_contrast', settingsHighContrast ? 'true' : 'false');
  el.classList.toggle('active', settingsHighContrast);
  applyHighContrast();
}

function applyHighContrast() {
  document.documentElement.setAttribute('data-high-contrast', settingsHighContrast ? 'true' : 'false');
}

function confirmAccountDeletion() {
  if (!confirm('정말로 계정을 탈퇴하시겠습니까?\n모든 분석 기록과 설정이 삭제됩니다.')) return;
  if (!confirm('이 작업은 되돌릴 수 없습니다. 정말 진행하시겠습니까?')) return;
  localStorage.removeItem('cs_analysis_history');
  localStorage.removeItem('cs_theme');
  localStorage.removeItem('cs_auto_analysis');
  localStorage.removeItem('cs_easy_level');
  localStorage.removeItem('cs_high_contrast');
  localStorage.removeItem('gsi_token');
  location.reload();
}

// ---- History ----
function saveToHistory(data, filename) {
  if (!currentUser || isDemoMode) return;
  const history = JSON.parse(localStorage.getItem('cs_analysis_history') || '[]');
  const entry = {
    id: Date.now(),
    filename: filename,
    date: new Date().toLocaleString('ko-KR'),
    riskLevel: data.summary?.riskLevel || 'unknown',
    riskGrade: data.summary?.riskLevel === 'high' ? '위험' : data.summary?.riskLevel === 'medium' ? '주의' : '안전',
    deviatedCount: data.summary?.deviatedClauseCount || 0,
    totalCount: data.summary?.totalClauseCount || 0,
    totalMaxRisk: data.summary?.totalMaxRisk || 0,
    data: data,
  };
  history.unshift(entry);
  if (history.length > 20) history.pop();
  localStorage.setItem('cs_analysis_history', JSON.stringify(history));
}

function renderHistorySection() {
  const section = document.getElementById('historySection');
  if (!section) return;
  if (!currentUser) { section.style.display = 'none'; return; }
  const history = JSON.parse(localStorage.getItem('cs_analysis_history') || '[]');
  if (history.length === 0) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  const list = document.getElementById('historyList');
  if (!list) return;
  const recent = history.slice(0, 5);
  list.innerHTML = recent.map((item, idx) =>
    '<div onclick="loadHistoryEntry(' + idx + ')" class="flex items-center justify-between p-3 rounded-lg hover:bg-white/5 transition-colors cursor-pointer group border border-transparent hover:border-[var(--border-color)]">' +
      '<div class="flex items-center gap-3">' +
        '<div class="w-8 h-8 rounded flex items-center justify-center border ' +
          (item.riskLevel === 'high' ? 'bg-red-500/10 text-red-400 border-red-500/20' : item.riskLevel === 'medium' ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' : 'bg-green-500/10 text-green-400 border-green-500/20') + '">' +
          '<span class="material-symbols-outlined text-sm">description</span></div>' +
        '<div><p class="text-sm font-medium group-hover:text-indigo-300 transition-colors" style="color:var(--text-primary)">' + item.filename + '</p>' +
        '<p class="text-xs" style="color:var(--text-muted)">' + item.date + '</p></div></div>' +
      '<div class="flex items-center gap-2">' +
        '<span class="px-2 py-1 rounded text-[10px] font-medium border ' +
          (item.riskLevel === 'high' ? 'bg-red-500/10 text-red-400 border-red-500/20' : item.riskLevel === 'medium' ? 'bg-amber-500/10 text-amber-400 border-amber-500/20' : 'bg-green-500/10 text-green-400 border-green-500/20') + '">' +
          item.riskGrade + '</span>' +
        '<span class="material-symbols-outlined text-gray-600 group-hover:text-gray-400">chevron_right</span></div></div>'
  ).join('');
}

function loadHistoryEntry(idx) {
  const history = JSON.parse(localStorage.getItem('cs_analysis_history') || '[]');
  const entry = history[idx];
  if (!entry) return;
  isDemoMode = false;
  uploadedFileUrl = null;
  uploadedFileType = null;
  analysisData = entry.data;
  renderResults(entry.data, entry.filename);
}

function clearHistory() {
  if (confirm('모든 분석 기록을 삭제하시겠습니까?')) {
    localStorage.removeItem('cs_analysis_history');
    renderHistorySection();
    if (currentPanel === 'settings') renderSettingsPanel();
    if (currentPanel === 'archive') renderArchivePanel();
  }
}

// ---- Screen Management ----
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  // Track previous screen (only non-settings screens)
  const currentActive = document.querySelector('.screen.active');
  if (currentActive && name === 'settings') {
    const reverseMap = { introScreen: 'intro', uploadScreen: 'upload', loadingScreen: 'loading', resultScreen: 'result' };
    previousScreenName = reverseMap[currentActive.id] || previousScreenName;
  }

  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screenMap = { intro: 'introScreen', upload: 'uploadScreen', loading: 'loadingScreen', result: 'resultScreen', settings: 'settingsScreen' };
  const el = document.getElementById(screenMap[name]);
  if (el) el.classList.add('active');

  // Unified sidebar: show/hide
  const sidebar = document.getElementById('unifiedSidebar');
  if (sidebar) sidebar.style.display = name === 'intro' ? 'none' : 'flex';

  // Update sidebar active state
  updateSidebarActiveState(name);

  // Close any open panels
  closeSidebarPanel();

  // Render history on upload screen
  if (name === 'upload') renderHistorySection();

  // Render settings screen
  if (name === 'settings') renderSettingsScreen();
}

function updateSidebarActiveState(name) {
  document.querySelectorAll('.sidebar-nav-btn').forEach(btn => btn.classList.remove('active'));
  const map = { upload: 'sidebarBtnUpload', loading: 'sidebarBtnUpload', result: 'sidebarBtnUpload', settings: 'sidebarBtnSettings' };
  const activeBtn = document.getElementById(map[name]);
  if (activeBtn) activeBtn.classList.add('active');
}

// ---- File Handling ----
function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) uploadFile(file);
}

// Drag and drop
document.addEventListener('DOMContentLoaded', () => {
  checkSavedLogin();
  initGoogleLogin();
  applyTheme();
  applyHighContrast();
  currentTabLevel = settingsEasyLevel;
  renderHistorySection();

  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('googleLoginDropdown');
    const loginBtn = document.getElementById('loginBtnIntro');
    if (dropdown && loginBtn && !loginBtn.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });

  const dropArea = document.getElementById('dropArea');
  if (!dropArea) return;
  ['dragenter','dragover'].forEach(ev => {
    dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropArea.classList.add('border-indigo-500/50','bg-white/[0.06]'); });
  });
  ['dragleave','drop'].forEach(ev => {
    dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('border-indigo-500/50','bg-white/[0.06]'); });
  });
  dropArea.addEventListener('drop', e => {
    const file = e.dataTransfer.files[0];
    if (file) uploadFile(file);
  });
});

// ---- Upload ----
async function uploadFile(file) {
  const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB
  if (file.size > MAX_FILE_SIZE) {
    alert('파일이 너무 큽니다. 최대 20MB까지 업로드할 수 있습니다.');
    return;
  }

  isDemoMode = false;
  uploadedFileUrl = URL.createObjectURL(file);
  uploadedFileType = file.type;

  loadingStartTime = Date.now();
  showScreen('loading');
  animateLoading();

  const formData = new FormData();
  formData.append('file', file);

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 90000); // 90s timeout

  try {
    const res = await fetch('/api/analyze', { method: 'POST', body: formData, signal: controller.signal });
    clearTimeout(timeoutId);
    if (!res.ok) {
      if (res.status === 413) {
        alert('파일이 너무 큽니다 (최대 20MB)');
        showScreen('upload');
        return;
      }
      throw new Error(`HTTP ${res.status}`);
    }
    const data = await res.json();
    analysisData = data;
    renderResults(data, file.name);
  } catch (err) {
    console.error('Upload failed:', err);
    try {
      const res2 = await fetch('/static/fallback.json');
      const data2 = await res2.json();
      data2.analysisMode = 'fallback';
      analysisData = data2;
      renderResults(data2, file.name);
    } catch {
      alert('분석에 실패했습니다. 잠시 후 다시 시도해주세요.');
      showScreen('upload');
    }
  }
}

// ---- Demo ----
async function loadDemo() {
  isDemoMode = true;
  uploadedFileUrl = null;
  uploadedFileType = null;

  loadingStartTime = Date.now();
  showScreen('loading');
  animateLoading();

  try {
    const res = await fetch('/api/demo');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    analysisData = data;
    renderResults(data, '[데모] 주택임대차계약서 샘플');
  } catch (err) {
    console.error('Demo fetch failed:', err);
    try {
      const res2 = await fetch('/static/fallback.json');
      const data2 = await res2.json();
      analysisData = data2;
      renderResults(data2, '[데모] 주택임대차계약서 샘플');
    } catch (err2) {
      console.error('Fallback fetch failed:', err2);
      alert('데모 데이터를 불러올 수 없습니다.');
      showScreen('intro');
    }
  }
}

// ---- Loading Animation ----
function animateLoading() {
  const bar = document.getElementById('progressBar');
  const statusText = document.getElementById('loadingStatusText');
  if (!bar) return;
  bar.style.width = '0%';
  const steps = [
    { pct: 20, text: '계약서를 읽고 있습니다...' },
    { pct: 45, text: '조항을 추출하고 있습니다...' },
    { pct: 65, text: '표준 계약서와 비교 중...' },
    { pct: 80, text: '위험 요소를 분석하는 중...' },
    { pct: 92, text: '행동 스크립트를 생성하는 중...' },
  ];
  steps.forEach((s, i) => {
    setTimeout(() => {
      bar.style.width = s.pct + '%';
      if (statusText) statusText.textContent = s.text;
    }, (i + 1) * 400);
  });
  // If analysis takes > 10s, show extended wait message
  setTimeout(() => {
    if (document.getElementById('loadingScreen')?.classList.contains('active')) {
      if (statusText) statusText.textContent = '심층 분석 중입니다. 잠시만 기다려주세요...';
    }
  }, 10000);
  // If > 30s, show longer wait message
  setTimeout(() => {
    if (document.getElementById('loadingScreen')?.classList.contains('active')) {
      if (statusText) statusText.textContent = '복잡한 계약서를 분석 중입니다. 조금만 더 기다려주세요...';
    }
  }, 30000);
}

// ---- File Preview ----
function renderFilePreview() {
  const section = document.getElementById('filePreviewSection');
  const content = document.getElementById('filePreviewContent');
  const demoBanner = document.getElementById('demoBanner');
  const fallbackBanner = document.getElementById('fallbackBanner');
  const demoTag = document.getElementById('resultDemoTag');

  // Show/hide fallback banner based on analysisMode
  const isFallback = analysisData?.analysisMode === 'fallback';
  if (fallbackBanner) {
    fallbackBanner.classList.toggle('hidden', !isFallback || isDemoMode);
  }

  if (isDemoMode) {
    section.classList.add('hidden');
    demoBanner.classList.remove('hidden');
    demoTag.classList.remove('hidden');
  } else {
    demoBanner.classList.add('hidden');
    demoTag.classList.add('hidden');
    if (uploadedFileUrl) {
      section.classList.remove('hidden');
      content.innerHTML = '';
      if (uploadedFileType === 'application/pdf') {
        content.innerHTML = `<iframe src="${uploadedFileUrl}" class="w-full h-full border-0" title="원본 PDF"></iframe>`;
      } else if (uploadedFileType && uploadedFileType.startsWith('image/')) {
        content.innerHTML = `<img src="${uploadedFileUrl}" class="max-h-full max-w-full object-contain p-2" alt="원본 이미지"/>`;
      } else if (uploadedFileType === 'text/html') {
        content.innerHTML = `<iframe src="${uploadedFileUrl}" sandbox="allow-same-origin" class="w-full h-full border-0 bg-white rounded" title="원본 HTML"></iframe>`;
      } else if (uploadedFileType && uploadedFileType.startsWith('text/')) {
        fetch(uploadedFileUrl).then(r => r.text()).then(text => {
          content.innerHTML = `<pre class="w-full h-full overflow-auto p-4 text-sm text-gray-300 bg-[#0d0d14] rounded whitespace-pre-wrap">${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`;
        }).catch(() => {
          content.innerHTML = '<div class="text-gray-400 text-sm flex items-center gap-2"><span class="material-symbols-outlined">error</span>파일을 읽을 수 없습니다</div>';
        });
      } else {
        content.innerHTML = `<div class="text-gray-400 text-sm flex items-center gap-2"><span class="material-symbols-outlined">description</span>파일 미리보기를 지원하지 않는 형식입니다</div>`;
      }
    } else {
      section.classList.add('hidden');
    }
  }
}

function toggleFilePreview() {
  const container = document.getElementById('filePreviewContainer');
  const icon = document.getElementById('filePreviewToggleIcon');
  filePreviewOpen = !filePreviewOpen;
  if (filePreviewOpen) {
    container.style.maxHeight = '200px';
    icon.textContent = 'expand_more';
  } else {
    container.style.maxHeight = '0';
    icon.textContent = 'chevron_right';
  }
}

// ---- Render Results ----
function renderResults(data, filename) {
  const elapsed = Date.now() - loadingStartTime;
  const minDelay = 2000;
  const remaining = Math.max(0, minDelay - elapsed);

  setTimeout(() => {
    // Top bar
    document.getElementById('resultFileName').textContent = filename || '계약서';
    const badge = document.getElementById('resultRiskBadge');
    const rl = data.summary?.riskLevel || 'high';
    if (rl === 'high') { badge.textContent = '위험'; badge.className = 'px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600'; }
    else if (rl === 'medium') { badge.textContent = '주의'; badge.className = 'px-2.5 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-600'; }
    else { badge.textContent = '안전'; badge.className = 'px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-600'; }

    // Summary cards
    document.getElementById('summaryRiskCount').textContent = data.summary?.deviatedClauseCount || 0;
    document.getElementById('summaryTotalCount').textContent = data.summary?.totalClauseCount || 0;
    const maxRisk = data.summary?.totalMaxRisk || 0;
    document.getElementById('summaryMaxRisk').textContent = '\u20A9' + maxRisk.toLocaleString();

    // File preview / demo banner
    renderFilePreview();

    // Render contract clauses (Grammarly annotation view)
    renderContractDocument(data);

    // Render checklist
    renderChecklist(data);

    // Overall action
    if (data.overallAction) {
      document.getElementById('overallActionBox').classList.remove('hidden');
      document.getElementById('overallActionText').textContent = data.overallAction.message;
    }

    // Charts
    renderDeviationChart(data);
    renderRiskChart(data);

    // Comprehension quiz
    if (data.comprehension) {
      renderComprehension(data.comprehension);
    } else {
      document.getElementById('comprehensionSection').classList.add('hidden');
    }

    // Save to history
    saveToHistory(data, filename);

    // Show result
    showScreen('result');
    closePanelDetail();
  }, remaining);
}

// ---- Merge & Sort Clauses ----
function mergeAndSortClauses(data) {
  const allClauses = [];

  // Safe clauses
  (data.safeClausesSummary || []).forEach(sc => {
    allClauses.push({
      number: sc.number, title: sc.title,
      deviationScore: sc.deviationScore, status: sc.status,
      body: sc.body || '', isRisk: false,
    });
  });

  // Risk clauses
  (data.clauses || []).forEach((c, idx) => {
    allClauses.push({ ...c, isRisk: true, riskIdx: idx });
  });

  // Sort by clause number
  allClauses.sort((a, b) => {
    const numA = parseInt((a.number || '').replace(/[^0-9]/g, '')) || 0;
    const numB = parseInt((b.number || '').replace(/[^0-9]/g, '')) || 0;
    return numA - numB;
  });

  return allClauses;
}

// ---- Contract Document Viewer (Grammarly Annotation Style) ----
function renderContractDocument(data) {
  const container = document.getElementById('clauseList');
  container.innerHTML = '';

  const allClauses = mergeAndSortClauses(data);

  allClauses.forEach((clause) => {
    const div = document.createElement('div');
    const clauseNum = (clause.number || '').replace(/[^0-9]/g, '');
    div.id = `clause-${clauseNum}`;

    if (clause.isRisk) {
      const level = clause.deviationScore >= 80 ? 'danger' : 'caution';
      const bgColor = level === 'danger' ? 'bg-red-500' : 'bg-amber-500';
      const tooltipText = clause.easyKorean?.level1 || '';

      div.className = `annotation-${level} rounded-lg p-4 mb-3 pr-12 relative`;
      div.setAttribute('data-idx', clause.riskIdx);
      div.onclick = () => openDetail(clause.riskIdx);
      div.innerHTML = `
        <div class="flex items-center gap-2 mb-2">
          <span class="font-bold text-gray-900">${clause.number}</span>
          <span class="font-medium text-gray-700">${clause.title}</span>
          <span class="px-2 py-0.5 rounded text-[10px] font-bold ${level === 'danger' ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-600'}">
            ${level === 'danger' ? '위험' : '주의'} ${clause.deviationScore}%
          </span>
        </div>
        <p class="text-sm text-gray-700 leading-relaxed serif-text">${clause.body || clause.original || ''}</p>
        <!-- Margin marker -->
        <div class="annotation-marker ${bgColor} text-white">${clause.riskIdx + 1}</div>
        <!-- Hover tooltip -->
        ${tooltipText ? `<div class="annotation-tooltip">${tooltipText}</div>` : ''}
      `;
    } else {
      div.className = 'p-4 mb-3 border-l-2 border-transparent hover:border-gray-200 transition-colors rounded-lg';
      div.innerHTML = `
        <div class="flex items-center gap-2 mb-1">
          <span class="font-bold text-gray-900 text-sm">${clause.number}</span>
          <span class="font-medium text-gray-600 text-sm">${clause.title}</span>
          <span class="text-[10px] px-1.5 py-0.5 rounded ${clause.status === 'caution' ? 'bg-amber-50 text-amber-500' : 'bg-green-50 text-green-500'}">
            ${clause.status === 'caution' ? '주의' : '안전'}
          </span>
        </div>
        ${clause.body ? `<p class="text-sm text-gray-500 leading-relaxed serif-text">${clause.body}</p>` : ''}
      `;
    }

    container.appendChild(div);
  });
}

// ---- Scroll to Clause (from checklist) ----
function scrollToClause(clauseNumber) {
  const num = (clauseNumber || '').replace(/[^0-9]/g, '');
  const el = document.getElementById(`clause-${num}`);
  if (el) {
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    el.classList.add('clause-pulse');
    setTimeout(() => el.classList.remove('clause-pulse'), 2000);
  }
}

// ---- Checklist ----
function renderChecklist(data) {
  const container = document.getElementById('checklistItems');
  container.innerHTML = '';
  (data.clauses || []).forEach((c, idx) => {
    const isUrgent = c.action?.priority === 'urgent';
    const div = document.createElement('div');
    div.className = 'p-3 rounded-xl border cursor-pointer transition-all hover:shadow-sm ' +
      (isUrgent ? 'border-red-200 bg-red-50 hover:bg-red-100' : 'border-amber-200 bg-amber-50 hover:bg-amber-100');
    div.onclick = () => {
      scrollToClause(c.number);
      openDetail(idx);
    };
    div.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-base ${isUrgent ? 'text-red-500' : 'text-amber-500'}">${isUrgent ? 'error' : 'warning'}</span>
          <span class="text-sm font-medium text-gray-800">${c.number} ${c.title}</span>
        </div>
        <span class="material-symbols-outlined text-gray-400 text-base">chevron_right</span>
      </div>
      <p class="text-xs text-gray-500 mt-1 ml-7">${c.easyKorean?.level1 || ''}</p>
    `;
    container.appendChild(div);
  });
}

// ---- Open Detail Panel ----
function openDetail(idx) {
  const clause = analysisData?.clauses?.[idx];
  if (!clause) return;
  currentClauseIdx = idx;
  currentTabLevel = 1;

  // Highlight active clause in annotation view
  document.querySelectorAll('[data-idx]').forEach(el => {
    const isActive = parseInt(el.dataset.idx) === idx;
    el.classList.toggle('ring-2', isActive);
    el.classList.toggle('ring-indigo-400', isActive);
  });

  // Fill detail panel
  document.getElementById('detailNumber').textContent = clause.number;
  document.getElementById('detailTitle').textContent = clause.title;

  const badge = document.getElementById('detailBadge');
  const score = clause.deviationScore || 0;
  if (score >= 80) { badge.textContent = '위험'; badge.className = 'px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-600'; }
  else if (score >= 50) { badge.textContent = '주의'; badge.className = 'px-2 py-0.5 rounded text-xs font-bold bg-amber-100 text-amber-600'; }
  else { badge.textContent = '안전'; badge.className = 'px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-600'; }

  document.getElementById('detailScore').textContent = score + '%';
  const bar = document.getElementById('detailScoreBar');
  bar.style.width = score + '%';
  bar.className = 'h-full rounded-full transition-all duration-500 ' +
    (score >= 80 ? 'bg-red-500' : score >= 50 ? 'bg-amber-500' : 'bg-green-500');

  document.getElementById('detailDirection').textContent = clause.direction || '';
  document.getElementById('detailOriginal').textContent = clause.original || '';
  document.getElementById('detailStandard').textContent = clause.standard || '';
  document.getElementById('detailActionMessage').textContent = clause.action?.message || '';

  // Action box color
  const actionBox = document.getElementById('detailActionBox');
  if (clause.action?.type === 'danger') {
    actionBox.className = 'bg-red-50 border border-red-200 rounded-xl p-4';
    actionBox.querySelector('h4').className = 'text-sm font-bold text-red-700 mb-2 flex items-center gap-1.5';
    actionBox.querySelector('p').className = 'text-sm text-red-800 whitespace-pre-line leading-relaxed';
  } else {
    actionBox.className = 'bg-amber-50 border border-amber-200 rounded-xl p-4';
    actionBox.querySelector('h4').className = 'text-sm font-bold text-amber-700 mb-2 flex items-center gap-1.5';
    actionBox.querySelector('p').className = 'text-sm text-amber-800 whitespace-pre-line leading-relaxed';
  }

  // Tab content
  switchTab(1);

  // Structured Breakdown
  const breakdownSection = document.getElementById('detailBreakdown');
  const breakdownContent = document.getElementById('detailBreakdownContent');
  if (clause.structuredBreakdown) {
    const sb = clause.structuredBreakdown;
    const fields = [
      { key: 'who', label: '누가', icon: 'person' },
      { key: 'what', label: '무엇을', icon: 'description' },
      { key: 'when', label: '언제', icon: 'schedule' },
      { key: 'condition', label: '조건', icon: 'rule' },
      { key: 'result', label: '결과', icon: 'check_circle' },
      { key: 'risk', label: '위험', icon: 'warning' },
    ];
    breakdownContent.innerHTML = fields
      .filter(f => sb[f.key])
      .map(f => `
        <div class="flex items-start gap-3">
          <span class="material-symbols-outlined text-sm ${f.key === 'risk' ? 'text-red-500' : 'text-indigo-400'} mt-0.5">${f.icon}</span>
          <div>
            <span class="text-xs font-bold ${f.key === 'risk' ? 'text-red-600' : 'text-indigo-600'}">${f.label}</span>
            <p class="text-sm text-gray-700">${sb[f.key]}</p>
          </div>
        </div>
      `).join('');
    breakdownSection.classList.remove('hidden');
  } else {
    breakdownSection.classList.add('hidden');
  }

  // Term Glossary
  const glossarySection = document.getElementById('detailGlossary');
  const glossaryContent = document.getElementById('detailGlossaryContent');
  if (clause.termGlossary && clause.termGlossary.length > 0) {
    glossaryContent.innerHTML = clause.termGlossary.map(term => `
      <div class="bg-purple-50/50 border border-purple-100 rounded-xl p-3">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-sm font-bold text-purple-700">${term.original}</span>
          <span class="material-symbols-outlined text-xs text-gray-400">arrow_forward</span>
          <span class="text-sm font-medium text-purple-600">${term.simple}</span>
        </div>
        ${term.context ? `<p class="text-xs text-gray-500 ml-0.5">${term.context}</p>` : ''}
      </div>
    `).join('');
    glossarySection.classList.remove('hidden');
  } else {
    glossarySection.classList.add('hidden');
  }

  // Show detail panel, hide default
  document.getElementById('panelDefault').classList.add('hidden');
  document.getElementById('panelDetail').classList.remove('hidden');
}

function closePanelDetail() {
  document.getElementById('panelDefault').classList.remove('hidden');
  document.getElementById('panelDetail').classList.add('hidden');
  document.querySelectorAll('[data-idx]').forEach(el => {
    el.classList.remove('ring-2', 'ring-indigo-400');
  });
  currentClauseIdx = -1;
}

// ---- Easy Korean Tabs ----
function switchTab(level) {
  currentTabLevel = level;
  const clause = analysisData?.clauses?.[currentClauseIdx];
  if (!clause) return;

  const content = document.getElementById('easyKoreanContent');
  const levels = { 1: clause.easyKorean?.level1, 2: clause.easyKorean?.level2, 3: clause.easyKorean?.level3 };
  content.textContent = levels[level] || '';

  // Update tab styles
  const tabs = document.querySelectorAll('#panelDetail .tab-btn');
  tabs.forEach((t, i) => {
    if (i + 1 === level) {
      t.className = 'tab-btn active-tab text-sm font-medium text-indigo-600';
    } else {
      t.className = 'tab-btn text-sm font-medium text-gray-400 hover:text-gray-600';
    }
  });
}

// ---- Charts ----
function renderDeviationChart(data) {
  const ctx = document.getElementById('deviationChart');
  if (!ctx) return;
  if (deviationChartInstance) deviationChartInstance.destroy();

  const clauses = data.clauses || [];
  deviationChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: clauses.map(c => c.number),
      datasets: [{
        label: '이탈도 (%)',
        data: clauses.map(c => c.deviationScore),
        backgroundColor: clauses.map(c => c.deviationScore >= 80 ? '#EF4444' : c.deviationScore >= 50 ? '#F59E0B' : '#10B981'),
        borderRadius: 6,
        barThickness: 28,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, max: 100, ticks: { font: { size: 11 } }, grid: { color: '#f3f4f6' } },
        x: { ticks: { font: { size: 11 } }, grid: { display: false } },
      }
    }
  });
}

function renderRiskChart(data) {
  const ctx = document.getElementById('riskChart');
  if (!ctx) return;
  if (riskChartInstance) riskChartInstance.destroy();

  const clauses = data.clauses || [];
  const safe = (data.safeClausesSummary || []).length;
  const danger = clauses.filter(c => c.deviationScore >= 80).length;
  const caution = clauses.filter(c => c.deviationScore < 80).length;

  riskChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['위험', '주의', '안전'],
      datasets: [{
        data: [danger, caution, safe],
        backgroundColor: ['#EF4444', '#F59E0B', '#10B981'],
        borderWidth: 0,
        spacing: 2,
      }]
    },
    options: {
      responsive: true,
      cutout: '65%',
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 12 }, padding: 16, usePointStyle: true, pointStyleWidth: 10 } }
      }
    }
  });
}

// ---- Copy Action ----
function copyAction() {
  const text = document.getElementById('detailActionMessage')?.textContent || '';
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('#detailActionBox button');
    const orig = btn.innerHTML;
    btn.innerHTML = '<span class="material-symbols-outlined text-sm">check</span> 복사됨!';
    setTimeout(() => { btn.innerHTML = orig; }, 1500);
  });
}

// ---- Comprehension Quiz ----
function renderComprehension(comp) {
  const section = document.getElementById('comprehensionSection');
  const container = document.getElementById('comprehensionContent');
  container.innerHTML = '';

  let hasContent = false;

  // Cloze Questions
  if (comp.clozeQuestions && comp.clozeQuestions.length > 0) {
    hasContent = true;
    const clozeHtml = comp.clozeQuestions.map((cq, idx) => `
      <div class="bg-white rounded-xl border border-gray-200 p-5" id="cloze-${idx}">
        <div class="flex items-center gap-2 mb-3">
          <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-600">빈칸 채우기</span>
          <span class="text-xs text-gray-400">${cq.clauseNumber || ''}</span>
        </div>
        <p class="text-sm text-gray-800 leading-relaxed mb-3">${(cq.sentence || cq.question || '').replace(/___/g, '<span class="inline-block w-24 border-b-2 border-indigo-300 mx-1"></span>')}</p>
        <div class="flex items-center gap-2">
          <input type="text" class="flex-1 px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 outline-none" placeholder="답을 입력하세요" id="cloze-input-${idx}" onkeydown="if(event.key==='Enter')checkClozeAnswer(${idx})">
          <button onclick="checkClozeAnswer(${idx})" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm rounded-lg font-medium transition-colors">확인</button>
        </div>
        <div id="cloze-feedback-${idx}" class="mt-2 text-sm hidden"></div>
      </div>
    `).join('');
    container.innerHTML += clozeHtml;
  }

  // Scenario Questions
  if (comp.scenarioQuestions && comp.scenarioQuestions.length > 0) {
    hasContent = true;
    const scenarioHtml = comp.scenarioQuestions.map((sq, qIdx) => `
      <div class="bg-white rounded-xl border border-gray-200 p-5" id="scenario-${qIdx}">
        <div class="flex items-center gap-2 mb-3">
          <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-amber-100 text-amber-600">상황 문제</span>
          <span class="text-xs text-gray-400">${sq.clauseNumber || ''}</span>
        </div>
        <p class="text-sm text-gray-700 leading-relaxed mb-2 bg-gray-50 rounded-lg p-3">${sq.scenario || ''}</p>
        <p class="text-sm font-medium text-gray-800 mb-3">${sq.question || ''}</p>
        <div class="space-y-2">
          ${(sq.choices || []).map(ch => `
            <label class="scenario-choice flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors" id="scenario-${qIdx}-${ch.label}" onclick="selectScenarioAnswer(${qIdx}, '${ch.label}')">
              <input type="radio" name="scenario-${qIdx}" value="${ch.label}" class="mt-0.5 text-indigo-500 focus:ring-indigo-400">
              <div>
                <span class="text-sm font-medium text-gray-700">${ch.label}.</span>
                <span class="text-sm text-gray-600">${ch.text}</span>
              </div>
            </label>
          `).join('')}
        </div>
        <div id="scenario-feedback-${qIdx}" class="mt-3 text-sm hidden"></div>
      </div>
    `).join('');
    container.innerHTML += scenarioHtml;
  }

  // Recall Questions
  if (comp.recallQuestions && comp.recallQuestions.length > 0) {
    hasContent = true;
    const recallHtml = comp.recallQuestions.map((rq, rIdx) => `
      <div class="bg-white rounded-xl border border-gray-200 p-5" id="recall-${rIdx}">
        <div class="flex items-center gap-2 mb-3">
          <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-600">핵심 회상</span>
        </div>
        <p class="text-sm font-medium text-gray-800 mb-3">${rq.question || ''}</p>
        <div class="space-y-2">
          ${(rq.goldStandardIdeas || []).map((idea, iIdx) => `
            <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors">
              <input type="checkbox" class="mt-0.5 rounded text-green-500 focus:ring-green-400" id="recall-${rIdx}-${iIdx}">
              <span class="text-sm text-gray-700">${idea}</span>
            </label>
          `).join('')}
        </div>
        ${rq.scoringNote ? `<p class="text-xs text-gray-400 mt-3">${rq.scoringNote}</p>` : ''}
      </div>
    `).join('');
    container.innerHTML += recallHtml;
  }

  if (hasContent) {
    section.classList.remove('hidden');
  } else {
    section.classList.add('hidden');
  }
}

function checkClozeAnswer(idx) {
  const input = document.getElementById(`cloze-input-${idx}`);
  const feedback = document.getElementById(`cloze-feedback-${idx}`);
  if (!input || !feedback || !analysisData?.comprehension?.clozeQuestions) return;

  const cq = analysisData.comprehension.clozeQuestions[idx];
  if (!cq) return;

  const userAnswer = input.value.trim();
  if (!userAnswer) return;

  const correct = cq.answer || '';
  const synonyms = cq.acceptableSynonyms || [];
  const allAcceptable = [correct, ...synonyms].map(s => s.toLowerCase().trim());

  const isCorrect = allAcceptable.some(a => userAnswer.toLowerCase().includes(a) || a.includes(userAnswer.toLowerCase()));

  feedback.classList.remove('hidden');
  if (isCorrect) {
    feedback.innerHTML = '<span class="text-green-600 font-medium flex items-center gap-1"><span class="material-symbols-outlined text-base">check_circle</span> 정답! ' + correct + '</span>';
    input.classList.add('border-green-300', 'bg-green-50');
  } else {
    feedback.innerHTML = '<span class="text-red-500 font-medium flex items-center gap-1"><span class="material-symbols-outlined text-base">cancel</span> 정답: ' + correct + '</span>';
    input.classList.add('border-red-300', 'bg-red-50');
  }
}

function selectScenarioAnswer(qIdx, choice) {
  const feedback = document.getElementById(`scenario-feedback-${qIdx}`);
  if (!feedback || !analysisData?.comprehension?.scenarioQuestions) return;

  const sq = analysisData.comprehension.scenarioQuestions[qIdx];
  if (!sq) return;

  const isCorrect = choice === sq.correctAnswer;

  // Highlight choices
  (sq.choices || []).forEach(ch => {
    const el = document.getElementById(`scenario-${qIdx}-${ch.label}`);
    if (!el) return;
    el.classList.remove('border-green-300', 'bg-green-50', 'border-red-300', 'bg-red-50');
    if (ch.label === sq.correctAnswer) {
      el.classList.add('border-green-300', 'bg-green-50');
    } else if (ch.label === choice && !isCorrect) {
      el.classList.add('border-red-300', 'bg-red-50');
    }
  });

  feedback.classList.remove('hidden');
  if (isCorrect) {
    feedback.innerHTML = '<span class="text-green-600 font-medium flex items-center gap-1"><span class="material-symbols-outlined text-base">check_circle</span> 정답!</span>' +
      (sq.explanation ? '<p class="text-xs text-gray-500 mt-1">' + sq.explanation + '</p>' : '');
  } else {
    feedback.innerHTML = '<span class="text-red-500 font-medium flex items-center gap-1"><span class="material-symbols-outlined text-base">cancel</span> 오답</span>' +
      (sq.explanation ? '<p class="text-xs text-gray-500 mt-1">' + sq.explanation + '</p>' : '');
  }
}

// ---- Keyboard ----
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (document.getElementById('loginModal')?.classList.contains('open')) { closeLoginModal(); return; }
    if (document.getElementById('settingsScreen')?.classList.contains('active')) { goBackFromSettings(); return; }
    if (currentPanel) { closeSidebarPanel(); return; }
    if (currentClauseIdx >= 0) closePanelDetail();
  }
});
</script>

</body>
</html>
